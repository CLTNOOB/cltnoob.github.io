<!DOCTYPE html>
<html lang="pt-BR">
<head><!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H81BYYMM81"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-H81BYYMM81');
</script>
<meta charset="UTF-8">
<title>SimulaÃ§Ã£o de NegÃ³cios</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:#fff}
header{text-align:center;padding:20px;background:rgba(0,0,0,.3)}
main{padding:25px;max-width:1200px;margin:auto}
.card{background:rgba(255,255,255,.08);border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}
.stat{background:rgba(0,0,0,.35);padding:15px;border-radius:10px;text-align:center}
button{padding:12px;border:none;border-radius:8px;cursor:pointer;background:#00c6ff;font-weight:bold;width:100%;margin-top:10px}
button:hover{background:#00a8dd}
button:disabled{opacity:.55;cursor:not-allowed}
.hidden{display:none} 
/* --- Tutorial overlay styles --- */
#tutorialOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:9999}
#tutorialOverlay.hidden{display:none}
#tutorialBox{background:linear-gradient(180deg,#1b2630,#12212a);padding:20px;border-radius:12px;width:90%;max-width:700px;color:#fff;box-shadow:0 20px 60px rgba(0,0,0,.6)}
#tutorialSteps{min-height:80px}
.tutorialNav{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.tutorialBtn{background:#00c6ff;color:#002a33;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:bold}
.tutorialBtn.secondary{background:#fff;color:#002a33}
#tutorialProgress{font-size:13px;color:#ccc;margin-bottom:8px}
/* ------------------------------- */
.arrows{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:10px}
.arrow{width:50px;height:50px;border-radius:50%;font-size:20px}
#graph{height:200px;background:#000;margin-top:15px;position:relative;overflow:hidden}
#chart{width:100%;height:200px;background:#000;border-radius:6px;display:block}
.trendUp{color:#0f0}
.trendDown{color:#f33}
.trendNeutral{color:#ccc}
#tradeInfo{background:rgba(255,255,255,0.03);border-radius:8px}
#closeTrade{width:100%}
/* O canvas Ã© desenhado por JS; a linha muda de cor conforme a direÃ§Ã£o atual */ 

/* --- Announcement & Changelog styles --- */
.announcement{background:linear-gradient(90deg,#ffb347,#ffcc33);color:#002a33;padding:10px;border-radius:8px;margin:12px auto;max-width:1200px;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,.25)}
.announcement .actions{margin-top:6px;display:flex;gap:8px;justify-content:center}
.announcement button{background:rgba(0,0,0,0.08);border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
.changelog{max-width:1200px;margin:12px auto;padding:12px;background:rgba(255,255,255,0.04);border-radius:10px}
.changelog-list{display:flex;flex-direction:column;gap:8px}
.changelog-item{background:rgba(0,0,0,0.25);padding:10px;border-radius:8px}
.changelog-new{display:inline-block;background:#00c853;color:#002a33;padding:4px 8px;border-radius:6px;font-weight:bold;margin-right:8px}
.log-btn{background:#00c6ff;color:#002a33;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
.log-btn.secondary{background:#fff;color:#002a33}

.endgame.locked{opacity:0.6;filter:grayscale(50%)}
.stat.endgame button{min-width:120px}

/* Dev panel */
.dev-panel{position:fixed;left:12px;bottom:12px;background:rgba(0,0,0,0.85);color:#fff;padding:12px;border-radius:8px;z-index:99999;box-shadow:0 8px 30px rgba(0,0,0,0.6);width:340px;font-size:13px}
.dev-panel h4{margin:0 0 8px 0;font-size:14px}
.dev-panel input, .dev-panel select{width:100%;padding:6px;margin:6px 0;border-radius:6px;border:none}
.dev-panel .row{display:flex;gap:8px}
.dev-panel button{flex:1;padding:8px;border-radius:6px;border:none;background:#00c6ff;color:#002a33;cursor:pointer}
.dev-panel .small{font-size:12px;color:#ccc}

</style>
</head>
<body>
<header>
<h1>ğŸ’¼ Simulador de NegÃ³cios</h1>
<p>Sistemas avanÃ§ados</p>
<div id="saveStatus" style="font-size:12px;color:#ccc;margin-top:6px">Ãšltimo save: â€”</div>
</header>
<!-- Announcement bar -->
<!-- Dev/testing panel (visible with ?dev=1 or Ctrl+Shift+D) -->
<div id="devPanel" class="dev-panel" style="display:none">
  <h4>Dev Panel</h4>
  <label>Dinheiro</label>
  <input id="devMoneyInput" type="number" placeholder="1000">
  <div class="row"><button onclick="devAddMoney()">Adicionar</button><button onclick="devReset()">Reset</button></div>

  <label>PrestÃ­gios</label>
  <input id="devPrestigeInput" type="number" placeholder="1">
  <div class="row"><button onclick="devAddPrestige()">Adicionar</button><button onclick="devSetPrestige(0)">Zerar</button></div>

  <label>NÃ­vel</label>
  <input id="devLevelInput" type="number" placeholder="1">
  <div class="row"><button onclick="devSetLevel()">Setar</button><button onclick="devAddMoney(10000)">+10k</button></div>

  <hr style="border:none;border-top:1px solid rgba(255,255,255,0.06);margin:8px 0">
  <label>Dar VeÃ­culo (nome)</label>
  <input id="devVehicleName" placeholder="Nome do veÃ­culo">
  <label>PreÃ§o</label>
  <input id="devVehiclePrice" type="number" placeholder="1000">
  <div class="row"><button onclick="devGiveVehicle()">Dar veÃ­culo</button><button onclick="devGiveVehiclesPreset()">Dar 3 veÃ­culos</button></div>

  <label>Dar Casa (nome)</label>
  <input id="devHouseName" placeholder="Nome da casa">
  <label>PreÃ§o</label>
  <input id="devHousePrice" type="number" placeholder="10000">
  <div class="row"><button onclick="devGiveHouse()">Dar casa</button><button onclick="devGiveHousesPreset()">Dar 3 casas</button></div>

  <div style="margin-top:8px" class="small">Atalho: Ctrl+Shift+D â€” ou abra com ?dev=1</div>
</div>
<div id="announcementBar" class="announcement">
  <strong>Novo!</strong> Novo sistema AFK â€” registra seus ganhos com renda passiva
  <div class="actions">
    <button onclick="abrir('atualizacoesFeitas')">Ver AtualizaÃ§Ãµes</button>
    <button onclick="dismissAnnouncement()" class="log-btn secondary">Fechar</button>
  </div>
</div>

<main>

<div class="card" id="changelog">
  <h2>ğŸ“ AtualizaÃ§Ãµes</h2>
  <div style="color:#ccc">As atualizaÃ§Ãµes foram movidas para a aba <strong>ğŸ”– AtualizaÃ§Ãµes jÃ¡ feitas</strong>. Clique para ver o histÃ³rico completo.</div>
  <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
    <button onclick="abrir('atualizacoesFeitas')" class="log-btn">Ver atualizaÃ§Ãµes</button>
  </div>
</div>

<div class="card" id="painelPrincipal">
<div class="stats">
<div class="stat">ğŸ’° Dinheiro<br><strong id="money">0</strong></div>
<div class="stat">ğŸ“ˆ Renda / clique<br><strong id="income">1</strong></div>
<div class="stat">ğŸ¢ NÃ­vel<br><strong id="level">1</strong></div>
<div class="stat">ğŸ¦ Renda Passiva<br><strong id="passive">0</strong></div>
<div class="stat">ğŸ… Medalhas<br><strong id="medals">0</strong></div>
<div class="stat">ğŸ’¸ EmprÃ©stimo<br><strong id="loan">0</strong></div>
</div>
<button onclick="ganharDinheiro()">Ganhar dinheiro</button>
  <button id="upgradeBtn" onclick="upgrade()">Upgrade (custo <span id="upgradeCost">100</span>)</button>
<button onclick="abrir('investimentos')">Investimentos</button>
<button onclick="abrir('emprestimos')">ğŸ’¸ EmprÃ©stimos</button>
<button onclick="abrir('graficos')">GrÃ¡ficos</button>
<button onclick="abrir('loja')">Loja</button>
<button onclick="abrir('galeria')">Galeria</button>
<button onclick="abrir('rankings')">ğŸ† Rankings</button>
<button onclick="abrir('settings')">âš™ï¸ ConfiguraÃ§Ãµes</button>
<button onclick="abrir('atualizacoesFeitas')">ğŸ“œ AtualizaÃ§Ãµes</button>
<button onclick="abrir('prestigios')">ğŸ… PrestÃ­gios</button>
<button onclick="salvar(true)">ğŸ’¾ Salvar Agora</button>
<button onclick="exportarSave()">â¬‡ï¸ Exportar Save</button>
<input id="importFile" class="hidden" type="file" accept="application/json" onchange="importarSave(event)">
<button onclick="document.getElementById('importFile').click()">â¬†ï¸ Importar Save</button>
<button onclick="apagarSave()">ğŸ—‘ï¸ Apagar Save</button>
<button onclick="showTutorial(true)">ğŸ“ Tutorial</button>
</div>

<div class="card hidden" id="investimentos">
<h2>ğŸ¦ Investimentos</h2>
<div class="stat">ğŸ  Casa Alugada<br>Custo: 5.000<br>Retorno: +50 / 30s<button onclick="comprarInvestimento(5000,50)">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸª Loja<br>Custo: 15.000<br>Retorno: +150 / 30s<button onclick="comprarInvestimento(15000,150)">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸ¢ PrÃ©dio<br>Custo: 50.000<br>Retorno: +500 / 30s<button onclick="comprarInvestimento(50000,500)">Comprar</button></div>

<!-- Novos investimentos -->
<div class="stat" style="margin-top:10px">ğŸ“ˆ Fundo de AÃ§Ãµes<br>Custo: 8.000<br>Retorno: +90 / 30s<button onclick="comprarInvestimento(8000,90)">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸ’³ TÃ­tulos PÃºblicos<br>Custo: 20.000<br>Retorno: +220 / 30s<button onclick="comprarInvestimento(20000,220)">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸª™ Criptomoeda<br>Custo: 12.000<br>Retorno: +170 / 30s<button onclick="comprarInvestimento(12000,170)">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸš€ Startup<br>Custo: 60.000<br>Retorno: +650 / 30s<button onclick="comprarInvestimento(60000,650)">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸ˜ï¸ Fundo ImobiliÃ¡rio<br>Custo: 35.000<br>Retorno: +350 / 30s<button onclick="comprarInvestimento(35000,350)">Comprar</button></div>

<!-- Novas casas (compram com funÃ§Ã£o dedicada para registrar na galeria) -->
<div style="margin-top:15px"><h3>ğŸ  Casas</h3></div>
<div class="stat">Casa Simples<br>Custo: 10.000<br>Retorno: +120 / 30s<button onclick="comprarCasa('Casa Simples',10000,120)">Comprar</button></div>
<div class="stat" style="margin-top:10px">Apartamento<br>Custo: 40.000<br>Retorno: +400 / 30s<button onclick="comprarCasa('Apartamento',40000,400)">Comprar</button></div>
<div class="stat" style="margin-top:10px">SÃ­tio<br>Custo: 80.000<br>Retorno: +800 / 30s<button onclick="comprarCasa('SÃ­tio',80000,800)">Comprar</button></div>
<div class="stat" style="margin-top:10px">Cobertura<br>Custo: 200.000<br>Retorno: +2200 / 30s<button onclick="comprarCasa('Cobertura',200000,2200)">Comprar</button></div>
<div class="stat" style="margin-top:10px">MansÃ£o<br>Custo: 800.000<br>Retorno: +10000 / 30s<button onclick="comprarCasa('MansÃ£o',800000,10000)">Comprar</button></div>

<!-- Novas casas (nÃ£o end-game) -->
<div class="stat" style="margin-top:10px">Studio<br>Custo: 5.000<br>Retorno: +60 / 30s<button onclick="comprarCasa('Studio',5000,60)">Comprar</button></div>
<div class="stat" style="margin-top:10px">Casa Moderna<br>Custo: 25.000<br>Retorno: +250 / 30s<button onclick="comprarCasa('Casa Moderna',25000,250)">Comprar</button></div>
<div class="stat" style="margin-top:10px">Townhouse<br>Custo: 60.000<br>Retorno: +600 / 30s<button onclick="comprarCasa('Townhouse',60000,600)">Comprar</button></div>
<div class="stat" style="margin-top:10px">Fazenda<br>Custo: 120.000<br>Retorno: +1300 / 30s<button onclick="comprarCasa('Fazenda',120000,1300)">Comprar</button></div>
<div class="stat" style="margin-top:10px">Villa<br>Custo: 350.000<br>Retorno: +3800 / 30s<button onclick="comprarCasa('Villa',350000,3800)">Comprar</button></div>

<div style="margin-top:15px"><h3>Casas End-Game (desbloqueadas por prestÃ­gios)</h3></div>
<div class="stat" style="margin-top:10px">ğŸ¢ CorporaÃ§Ã£o Global<br>Custo: 8.000.000<br>Retorno: 90.000 - 180.000 / 30s<button onclick="comprarCasa('CorporaÃ§Ã£o Global',8000000,[90000,180000])">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸ¬ ImpÃ©rio Multinacional<br>Custo: 20.000.000<br>Retorno: 225.000 - 450.000 / 30s<button onclick="comprarCasa('ImpÃ©rio Multinacional',20000000,[225000,450000])">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸ›ï¸ Conglomerado PlanetÃ¡rio<br>Custo: 56.000.000<br>Retorno: 630.000 - 1.080.000 / 30s<button onclick="comprarCasa('Conglomerado PlanetÃ¡rio',56000000,[630000,1080000])">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸŒ™ ColÃ´nia Lunar<br>Custo: 96.000.000<br>Retorno: 1.080.000 - 2.700.000 / 30s<button onclick="comprarCasa('ColÃ´nia Lunar',96000000,[1080000,2700000])">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸš€ EstaÃ§Ã£o Espacial<br>Custo: 2.000.000.000<br>Retorno: 15.000.000 / 30s<button onclick="comprarCasa('EstaÃ§Ã£o Espacial',2000000000,15000000)">Comprar</button></div> 

<button onclick="voltar()">â¬… Voltar</button>
</div>

<div class="card hidden" id="emprestimos">
  <h2>ğŸ’¸ EmprÃ©stimos</h2>
  <div class="stat">EmprÃ©stimo atual: <strong id="loanDisplay">0</strong></div>
  <div style="margin-top:10px;color:#ccc">Taxa padrÃ£o: <strong id="loanRateDisplay">2%</strong> por ciclo (30s). VocÃª pode pedir um emprÃ©stimo imediato e pagar parcialmente ou integralmente.</div>
  <div id="loanCooldown" style="margin-top:8px;color:#ffd54f"></div>
  <div style="margin-top:10px">
    <input id="loanAmountInput" type="number" placeholder="Valor do emprÃ©stimo" style="padding:8px;border-radius:6px;border:none;width:60%">
    <button onclick="requestLoan()" style="margin-left:8px">Pedir EmprÃ©stimo</button>
  </div>
  <div style="margin-top:10px">
    <input id="loanRepayInput" type="number" placeholder="Valor para pagar" style="padding:8px;border-radius:6px;border:none;width:60%">
    <button onclick="repayLoanInput()" style="margin-left:8px">Pagar EmprÃ©stimo</button>
    <button onclick="repayLoan(emprestimo)" style="margin-left:8px">Pagar Tudo</button>
  </div>
  <div style="margin-top:10px;color:#ccc;font-size:13px">AconselhÃ¡vel pagar juros rapidamente para evitar crescimento exponencial do dÃ©bito.</div>
  <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
    <button onclick="voltar()" class="log-btn secondary">Fechar</button>
  </div>
</div>

<div class="card hidden" id="graficos">
<h2>ğŸ“Š Mercado (alto risco)</h2>
<p>Escolha o valor e a direÃ§Ã£o</p>
<input id="valorInvest" type="number" placeholder="Valor para investir" style="width:100%;padding:10px;border-radius:6px;border:none">
<div id="graph">
  <canvas id="chart" width="800" height="200"></canvas>
</div>
<div id="marketInfo" style="margin-top:8px">PreÃ§o: <strong id="marketPrice">100.00</strong> | TendÃªncia: <strong id="marketTrend">Neutro</strong> | Status: <span id="marketStatus">Pronto</span></div>

<!-- Painel de informaÃ§Ãµes e controle do trade -->
<div id="tradeControls" style="margin-top:10px">
  <div id="tradeInfo" class="stat" style="padding:10px">Nenhum trade aberto</div>
  <button id="closeTrade" class="hidden" onclick="pararTrade()" style="background:#ff5252;color:#fff;padding:10px;border-radius:8px;margin-top:8px">Fechar Trade</button>
  <div style="font-size:12px;color:#ccc;margin-top:6px">Clique em <strong>â¬†</strong> para abrir compra (up) ou <strong>â¬‡</strong> para venda (down). Encerre com <strong>Fechar Trade</strong>.</div>
</div>

<div class="arrows"> 
<button class="arrow tradeOpenBtn" onclick="investirGrafico('up')">â¬†</button>
<button class="arrow tradeOpenBtn" onclick="investirGrafico('down')">â¬‡</button>
</div>  
<div style="margin-top:10px">Resultado: <strong id="resultadoGrafico">0</strong></div>
<button onclick="voltar()">â¬… Voltar</button>
</div>

<div class="card hidden" id="loja">
<h2>ğŸ›’ Loja</h2>
<div class="stat">ğŸš— BMW<br>PreÃ§o: 120.000<button onclick="comprarVeiculo('BMW',120000)">Comprar</button></div>
<div class="stat" style="margin-top:10px">âœˆï¸ AviÃ£o<br>PreÃ§o: 1.000.000<button onclick="comprarVeiculo('AviÃ£o',1000000)">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸï¸ Ferrari<br>PreÃ§o: 500.000<button onclick="comprarVeiculo('Ferrari',500000)">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸï¸ Moto<br>PreÃ§o: 30.000<button onclick="comprarVeiculo('Moto',30000)">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸšš CaminhÃ£o<br>PreÃ§o: 250.000<button onclick="comprarVeiculo('CaminhÃ£o',250000)">Comprar</button></div>
<div class="stat" style="margin-top:10px">â›µ Barco<br>PreÃ§o: 350.000<button onclick="comprarVeiculo('Barco',350000)">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸ”‹ Tesla<br>PreÃ§o: 220.000<button onclick="comprarVeiculo('Tesla',220000)">Comprar</button></div>
<!-- Novos carros adicionados -->
<div class="stat" style="margin-top:10px">ğŸš˜ XE<br>PreÃ§o: 90.000<button onclick="comprarVeiculo('XE',90000)">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸš˜ BMW 320i<br>PreÃ§o: 150.000<button onclick="comprarVeiculo('BMW 320i',150000)">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸš˜ Audi A3<br>PreÃ§o: 110.000<button onclick="comprarVeiculo('Audi A3',110000)">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸš˜ Toyota Corolla<br>PreÃ§o: 80.000<button onclick="comprarVeiculo('Toyota Corolla',80000)">Comprar</button></div>
<div class="stat" style="margin-top:10px">ğŸš˜ Honda Civic<br>PreÃ§o: 95.000<button onclick="comprarVeiculo('Honda Civic',95000)">Comprar</button></div>
<button onclick="voltar()">â¬… Voltar</button>
</div>

<div class="card hidden" id="galeria">
<h2>ğŸ–¼ï¸ Galeria</h2>
<button onclick="mostrarGaleria('veiculos')">VeÃ­culos</button>
<button onclick="mostrarGaleria('casas')">Casas</button>
<button onclick="mostrarGaleria('itens')">Itens</button>
<div id="listaGaleria" style="margin-top:15px"></div>
<button onclick="voltar()">â¬… Voltar</button>
</div>

<div class="card hidden" id="rankings">
  <h2>ğŸ† Rankings</h2>
  <div style="display:flex;gap:8px">
    <button onclick="mostrarRankingsTab('money')">Dinheiro</button>
    <button onclick="mostrarRankingsTab('time')">Tempo</button>
  </div>
  <div id="rankList" style="margin-top:12px"></div>
  <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
    <button onclick="submitToLeaderboards()">Enviar para Ranking</button>
    <button onclick="renderRankingTab(currentRankingTab||'money')">Atualizar</button>
    <button onclick="voltar()">â¬… Voltar</button>
  </div>
  <div id="rankNote" style="margin-top:10px;color:#ccc;font-size:13px"></div>
</div>

<div class="card hidden" id="settings">
  <h2>âš™ï¸ ConfiguraÃ§Ãµes</h2>
  <div id="settingsContent" style="margin-top:12px">
    <div>Nome: <strong id="settingsName">-</strong> <button onclick="definePlayerName()">Definir nome</button></div>
    <div>Dinheiro: <strong id="settingsMoney">0</strong></div>
    <div style="margin-top:8px"><label><input type="checkbox" id="optOutCheckbox" /> Excluir-me dos Rankings (opt-out)</label></div>
  </div>
  <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
    <button onclick="voltar()">â¬… Voltar</button>
  </div>
</div>
  <h2>ğŸ† Rankings</h2>
  <div style="display:flex;gap:8px">
    <button onclick="mostrarRankingsTab('money')">Dinheiro</button>
    <button onclick="mostrarRankingsTab('time')">Tempo</button>
  </div>
  <div id="rankList" style="margin-top:12px"></div>
  <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
    <button onclick="submitToLeaderboards()">Enviar para Ranking</button>
    <button onclick="renderRankingTab(currentRankingTab||'money')">Atualizar</button>
    <button onclick="voltar()">â¬… Voltar</button>
  </div>
  <div id="rankNote" style="margin-top:10px;color:#ccc;font-size:13px"></div>
</div>

<div class="card hidden" id="atualizacoesFeitas">
  <h2>ğŸ”– AtualizaÃ§Ãµes jÃ¡ feitas</h2>
  <div id="updateLogsList" class="changelog-list"></div>
  <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
    <button onclick="markLogsRead()" class="log-btn">Marcar como lidas</button>
    <button onclick="voltar()" class="log-btn secondary">Fechar</button>
  </div>
</div>

<div class="card hidden" id="prestigios">
  <h2>ğŸ… PrestÃ­gios</h2>
  <div id="prestigeInfo">
    <div>Medalhas: <strong id="prestigeCount">0</strong></div>
    <div>BÃ´nus atual: <strong id="prestigeBonus">0%</strong> (cada prestÃ­gio dÃ¡ +2% Ã  renda por clique e passiva)</div>
    <div>Requisito para prÃ³ximo prestÃ­gio: <strong id="prestigeReq">1.000.000</strong></div>
    <button id="prestigeBtn" onclick="attemptPrestige()">Prestigiar (Reset)</button>
    <div style="font-size:13px;color:#ccc;margin-top:8px">Ao prestigiar, vocÃª ganharÃ¡ 1 medalha e seu progresso serÃ¡ resetado (dinheiro, nÃ­vel, investimentos), mas manterÃ¡ suas medalhas e bÃ´nus.</div>
    <div id="medalRow" style="margin-top:10px"></div>
    <div id="prestigePreview" style="margin-top:10px;color:#ccc"></div>
    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.06);margin-top:12px" />
    <h3 style="margin-top:12px">ğŸ¬ Loja de PrestÃ­gios</h3>
    <div id="prestigeShop" style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
      <div class="changelog-item">ğŸ” Auto Clicker (0.5s) â€” Custo: <strong>2</strong> medalhas <button id="buyAutoClicker" onclick="buyPrestigeItem('autoClicker')" style="float:right">Comprar</button></div>
      <div class="changelog-item">ğŸ“ˆ +20% Renda Passiva (Ãºnico) â€” Custo: <strong>2</strong> medalhas <button id="buyPassiveBoost" onclick="buyPrestigeItem('passiveBoost')" style="float:right">Comprar</button></div>
      <div class="changelog-item">â±ï¸ Reduzir intervalo de renda passiva (5 compras disponÃ­veis; -2s por compra) â€” Custo: <strong>1</strong> medalha cada <button id="buyPassiveSpeed" onclick="buyPrestigeItem('passiveSpeed')" style="float:right">Comprar</button> <span id="passiveSpeedCount" style="margin-left:8px;color:#ccc">(0/5)</span></div>
      <div class="changelog-item">ğŸ·ï¸ Desconto Permanente de 10% (Ãºnico) â€” Custo: <strong>5</strong> medalhas <button id="buyDiscount" onclick="buyPrestigeItem('discount')" style="float:right">Comprar</button></div>
      <div class="changelog-item">âœ¨ Multiplicador Global +10% (Clickers & Investimentos) â€” <strong>Ãšnico</strong> â€” Custo: <strong>3</strong> medalhas <button id="buyGlobalMul" onclick="buyPrestigeItem('globalMultiplier')" style="float:right">Comprar</button></div>
    </div>
  </div>
  <button onclick="voltar()">â¬… Voltar</button>
</div>

<!-- Tutorial overlay (aparece apenas na primeira vez) -->
<div id="tutorialOverlay" class="hidden">
  <div id="tutorialBox">
    <h2>ğŸ“ Tutorial inicial</h2>
    <div id="tutorialProgress"></div>
    <div id="tutorialSteps"></div>
    <div class="tutorialNav">
      <button class="tutorialBtn secondary" onclick="prevTutorial()">â—€ï¸ Anterior</button>
      <button class="tutorialBtn" onclick="nextTutorial()">PrÃ³ximo â–¶ï¸</button>
      <button class="tutorialBtn" onclick="startGame()" id="tutorialSkip">Pular</button>
    </div>
  </div>
</div>

</main>
<script>
const MAX_UPGRADE_LEVEL = 100;
let dinheiro=0,renda=1,nivel=1,rendaPassiva=0,custoUpgrade=100,prestigios=0,emprestimo=0,emprestimoTaxa=0.02,emprestimoTakenAt=0;
let veiculosComprados=[],casasCompradas=[],isInvesting=false;
// Loja de PrestÃ­gios e timers
let prestigeShop = { autoClicker:false, passiveBoost:false, passiveSpeedCount:0, discount:false, globalMultiplier:false };
let passiveIntervalMs = 30000; let passiveIntervalId = null; let autoClickerIntervalId = null;

// Gallery & item system
let galleryItems = []; // itens especiais (ex: Cofre de Ouro)
let permanentItemBonuses = { passive: 0, click: 0 }; // bÃ´nus permanentes obtidos por itens
let activeBuffs = []; // buffs temporÃ¡rios (ex: poÃ§Ã£o de +25% clique com expiracao)

// Player profile & rankings
let playerName = '';
let playerNameSet = false; // marca que jÃ¡ perguntamos o nome (apenas uma vez)
let playTimeMs = 0; // tempo total jogado em ms (incrementado a cada segundo)
let sessionStart = Date.now();
let leaderboards = { money: [], time: [] };
let chosenNames = []; // nomes jÃ¡ escolhidos (Ãºnicos)
let playerOptOut = false; // se true, o usuÃ¡rio nÃ£o entra nos rankings
let currentRankingTab = 'money';


// ==========================
// ParÃ¢metros de mercado (fÃ¡cil de alterar)
// ==========================
const initialPrice = 100.00;        // preÃ§o inicial
const updateInterval = 500;         // ms entre atualizaÃ§Ãµes de preÃ§o (ex: 500ms)
const percentRange = 1.5;           // variaÃ§Ã£o mÃ¡xima percentual por tick (+/- percentRange)
const trendMinSec = 4;              // duraÃ§Ã£o mÃ­nima de uma tendÃªncia (segundos)
const trendMaxSec = 12;             // duraÃ§Ã£o mÃ¡xima de uma tendÃªncia (segundos)
const volatility = 1.0;             // multiplicador de volatilidade (ajusta amplitude)
const historyMax = 120;             // nÃºmero de pontos do grÃ¡fico visÃ­veis

// Estado do mercado
let marketPriceVal = initialPrice;
let priceHistory = Array(historyMax).fill(initialPrice);
let trend = { type: 'neutral', expiresAt: 0 };

// VariÃ¡veis de animaÃ§Ã£o e desenho
const canvas = document.getElementById('chart');
const ctx = canvas.getContext('2d');
let anim = { startPrice: marketPriceVal, endPrice: marketPriceVal, startTime: 0, duration: updateInterval };

// Estado de trade
let tradeStartPrice = 0, tradeStake = 0, tradeDir = null;

// Atualiza valores visuais e salva (sem forÃ§ar saltos no grÃ¡fico)
function atualizar(){
  money.innerText = dinheiro.toLocaleString();
  const mult = getPrestigeMultiplier();
  // renda por clique: mostra base e efetiva com bÃ´nus (inclui bÃ´nus permanentes de itens)
  const clickMultTotal = mult * (1 + (permanentItemBonuses.click || 0));
  income.innerHTML = `${renda} <small style="color:#ccc">(+${Math.round((clickMultTotal-1)*100)}% â†’ ${Math.floor(renda*clickMultTotal)})</small>`;
  level.innerText = nivel;
  const passiveMultTotal = mult * (1 + (permanentItemBonuses.passive || 0));
  passive.innerHTML = `${rendaPassiva.toLocaleString()} <small style="color:#ccc">(+${Math.round((passiveMultTotal-1)*100)}% â†’ ${Math.floor(rendaPassiva*passiveMultTotal).toLocaleString()})</small>`;
  renderPrestigios();
  updateEndgameUnlocks();
  // Mostrar custo ou indicar que chegou ao nÃ­vel mÃ¡ximo
  if (nivel >= MAX_UPGRADE_LEVEL){
    upgradeCost.innerText = 'MAX';
    const btn = document.getElementById('upgradeBtn'); if (btn) btn.disabled = true;
  } else {
    upgradeCost.innerText = custoUpgrade;
    const btn = document.getElementById('upgradeBtn'); if (btn) btn.disabled = false;
  }
  marketPrice.innerText = marketPriceVal.toFixed(2);
  marketTrend.innerText = trend.type.charAt(0).toUpperCase() + trend.type.slice(1);
  const loanEl = document.getElementById('loan'); if(loanEl) loanEl.innerText = emprestimo.toLocaleString();
  const loanDisplay = document.getElementById('loanDisplay'); if(loanDisplay) loanDisplay.innerText = emprestimo.toLocaleString();
  const loanRate = document.getElementById('loanRateDisplay'); if(loanRate) loanRate.innerText = Math.round(emprestimoTaxa*100) + '%';
  const loanCooldownEl = document.getElementById('loanCooldown'); if(loanCooldownEl){
    if(!emprestimo || emprestimo <= 0) loanCooldownEl.innerText = 'Sem dÃ­vida';
    else{
      const remain = Math.max(0, 300000 - (Date.now() - (emprestimoTakenAt || 0)));
      if(remain > 0){
        const mm = Math.floor(remain/60000); const ss = Math.floor((remain%60000)/1000);
        loanCooldownEl.innerText = `VocÃª poderÃ¡ pagar em ${mm}m ${ss}s`;
      } else {
        loanCooldownEl.innerText = 'VocÃª pode pagar o emprÃ©stimo agora';
      }
    }
  }
} 

// ==========================
// Motor de mercado (tendÃªncias e atualizaÃ§Ã£o periÃ³dica)
// ==========================
// Inicia mercado e ciclo de tendÃªncias
function startMarket(){
  // popular histÃ³rico se estiver vazio
  if(!priceHistory || priceHistory.length < historyMax) priceHistory = Array(historyMax).fill(marketPriceVal);
  scheduleNextTrend();
  scheduleTick();
  anim.startTime = performance.now();
  requestAnimationFrame(animate);
}

// Schedule a next trend cycle
function scheduleNextTrend(){
  const types = ['up','neutral','down'];
  // chance diferente: priorizar neutro e alta ligeiramente
  const r = Math.random();
  let t;
  if(r < 0.40) t = 'up';
  else if(r < 0.75) t = 'neutral';
  else t = 'down';
  const dur = (Math.random() * (trendMaxSec - trendMinSec) + trendMinSec) * 1000; // ms
  trend.type = t;
  trend.expiresAt = Date.now() + dur;
  // ao fim da duraÃ§Ã£o, agenda prÃ³xima tendÃªncia
  setTimeout(scheduleNextTrend, dur);
}

// Agende o prÃ³ximo tick de preÃ§o
function scheduleTick(){
  setTimeout(()=>{
    tickPrice();
    scheduleTick();
  }, updateInterval);
}

// Calcula novo preÃ§o baseado em tendÃªncia, ruÃ­do e volatilidade
function tickPrice(){
  // base random percentual entre -percentRange e +percentRange
  const base = (Math.random() * 2 - 1) * percentRange;
  // bias do trend: torna mais provÃ¡vel movimento na direÃ§Ã£o da tendÃªncia
  let bias = 0;
  if(trend.type === 'up') bias = Math.random() * (percentRange*0.6); // positive bias
  else if(trend.type === 'down') bias = -Math.random() * (percentRange*0.6); // negative bias
  // final percent considerando volatilidade
  const pct = (base + bias) * volatility;
  const newPrice = Math.max(0.01, marketPriceVal * (1 + pct/100));

  // Shift histÃ³rico
  priceHistory.push(newPrice);
  if(priceHistory.length > historyMax) priceHistory.shift();

  // ajustar animaÃ§Ã£o para transiÃ§Ã£o suave entre valores
  anim.startPrice = marketPriceVal;
  anim.endPrice = newPrice;
  anim.startTime = performance.now();
  anim.duration = updateInterval;

  marketPriceVal = newPrice;
  atualizar();
}

// Desenho e animaÃ§Ã£o contÃ­nua (requestAnimationFrame)
function animate(now){
  // interpolar Ãºltimo ponto para suavizar movimento
  let t = Math.min(1, (now - anim.startTime) / anim.duration);
  // usar ease in-out para suavizar
  const ease = (t*(2-t));
  const displayedLast = anim.startPrice + (anim.endPrice - anim.startPrice) * ease;

  // construir array de y-values a desenhar (substitui Ãºltimo item por displayedLast)
  const drawData = priceHistory.slice();
  drawData[drawData.length - 1] = displayedLast;

  drawChart(drawData);
  // atualizar informaÃ§Ãµes do trade em tempo real (P&L nÃ£o realizado)
  updateTradeInfo();
  requestAnimationFrame(animate);
}

// Desenha o grÃ¡fico no canvas (linha, cor conforme direÃ§Ã£o instantÃ¢nea)
function drawChart(data){
  const w = canvas.width = canvas.clientWidth;
  const h = canvas.height = canvas.clientHeight;

  // cleared background (fundo escuro)
  ctx.fillStyle = '#0a0a0a';
  ctx.fillRect(0,0,w,h);

  // calcular domÃ­nio vertical
  const min = Math.min(...data);
  const max = Math.max(...data);
  const pad = (max - min) * 0.1 + 0.0001;
  const vmin = min - pad;
  const vmax = max + pad;

  // mapeamento price -> y
  const priceToY = p => h - ((p - vmin) / (vmax - vmin)) * h;

  // decidir cor pela variaÃ§Ã£o recente
  const last = data[data.length-1];
  const prev = data[data.length-2] || last;
  const slopeUp = (last - prev) >= 0;
  ctx.lineWidth = 2;
  ctx.strokeStyle = slopeUp ? '#4caf50' : '#ff5252';
  ctx.beginPath();
  for(let i=0;i<data.length;i++){
    const x = (w * i) / (data.length - 1);
    const y = priceToY(data[i]);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // small marker for last price
  ctx.fillStyle = slopeUp ? '#4caf50' : '#ff5252';
  ctx.beginPath();
  const lx = w * (data.length - 1) / (data.length - 1);
  const ly = priceToY(last);
  ctx.arc(lx, ly, 3, 0, Math.PI*2);
  ctx.fill();
}

// ==========================
// Trade: abrir, fechar manualmente e calcular resultado
// ==========================
function investirGrafico(dir){
  if(isInvesting) return alert('JÃ¡ existe um trade em execuÃ§Ã£o');
  const v = Number(valorInvest.value);
  if(!v || v<=0 || v>dinheiro) return alert('Valor invÃ¡lido');
  // abrir posiÃ§Ã£o
  isInvesting = true;
  tradeStake = v;
  tradeDir = dir;
  tradeStartPrice = marketPriceVal;
  dinheiro -= v;
  // desabilita apenas os botÃµes de abrir trade (mantÃ©m botÃ£o de fechar ativo)
  document.querySelectorAll('.tradeOpenBtn').forEach(b=>b.disabled=true);
  document.getElementById('closeTrade').classList.remove('hidden');
  marketStatus.innerText = 'Trade Aberto';
  atualizar();
  updateTradeInfo();
}

// atualiza info do trade em tempo real (chamar dentro do loop de animaÃ§Ã£o ou ao mudar preÃ§o)
function updateTradeInfo(){
  const info = document.getElementById('tradeInfo');
  if(!isInvesting){
    info.innerHTML = 'Nenhum trade aberto';
    document.getElementById('closeTrade').classList.add('hidden');
    return;
  }

  const dirTxt = tradeDir === 'up' ? 'Compra (UP)' : 'Venda (DOWN)';
  const percentChange = (marketPriceVal - tradeStartPrice) / tradeStartPrice;
  const effectivePercent = (tradeDir === 'up') ? percentChange : -percentChange;

  const unrealized = Number((tradeStake * effectivePercent).toFixed(2));
  const sign = unrealized >= 0 ? '+' : '';

  info.innerHTML = `
    Trade: ${dirTxt}<br>
    Abertura: ${tradeStartPrice.toFixed(2)} | Stake: ${tradeStake}<br>
    P&L Atual: <strong style="color:${unrealized>=0?"#4caf50":"#ff5252"}">
      ${sign}${unrealized}
    </strong>
  `;

  const closeBtn = document.getElementById('closeTrade');
  closeBtn.textContent = `Fechar Trade â€” ${sign}${unrealized}`;
  closeBtn.style.background = unrealized >= 0 ? '#2e7d32' : '#b00020';
}



function pararTrade(){
  if(!isInvesting) return; // nada a fechar
  finalizarTrade();
}

function finalizarTrade(){
  // calcula mudanÃ§a percentual efetiva
  const percentChange = (marketPriceVal - tradeStartPrice) / tradeStartPrice;
  const effectivePercent = (tradeDir === 'up') ? percentChange : -percentChange;
  const ganho = Math.floor(tradeStake * effectivePercent);
  dinheiro += tradeStake + ganho;
  resultadoGrafico.innerText = ganho;
  marketStatus.innerText = ganho >= 0 ? 'Ganhou' : 'Perdeu';
  setTimeout(()=>{ marketStatus.innerText = 'Pronto'; }, 1200);
  // reabilita os botÃµes de abrir trade
  document.querySelectorAll('.tradeOpenBtn').forEach(b=>b.disabled=false);
  document.getElementById('closeTrade').classList.add('hidden');
  isInvesting = false; tradeStake = 0; tradeDir = null; tradeStartPrice = marketPriceVal;
  updateTradeInfo();
  atualizar();
} 
function getPrestigeMultiplier(){
  // agora cada prestÃ­gio dÃ¡ +5% e Ã© limitado a +50% (0.5)
  return 1 + Math.min(prestigios * 0.05, 0.5);
}
function ganharDinheiro(){
  // escala de clique ajustada: aumenta mais devagar com o nÃ­vel para evitar valores excessivos (ex: lvl100 â†’ ~6x)
  const levelMul = 1 + Math.floor(nivel / 20); // +1 a cada 20 nÃ­veis (lvl100 â†’ 6x)
  const globalMul = prestigeShop.globalMultiplier ? 1.10 : 1;
  const amount = Math.floor(renda * levelMul * getPrestigeMultiplier() * globalMul * getClickBuffMultiplier());
  dinheiro += amount;
  salvar(true); // persistir imediatamente apÃ³s clique para evitar perdas
  atualizar();
}
function upgrade(){
  if (nivel >= MAX_UPGRADE_LEVEL) return alert('VocÃª jÃ¡ atingiu o nÃ­vel mÃ¡ximo');
  if(dinheiro>=custoUpgrade){
    dinheiro-=custoUpgrade;
    renda += 1 + Math.floor(nivel * 0.1);
    nivel++;
    // aplicar escala mais suave a partir do nÃ­vel 71 (reduzir o multiplicador)
    if(nivel <= 70){
      custoUpgrade = Math.floor(custoUpgrade * 1.085);
    } else {
      custoUpgrade = Math.floor(custoUpgrade * 1.045);
    }
    atualizar();
  } else alert('Dinheiro insuficiente');
}
function applyDiscount(price){ return prestigeShop.discount ? Math.ceil(price * 0.9) : price; }

function comprarInvestimento(c,r){
  const price = applyDiscount(c);
  if(dinheiro>=price){
    dinheiro-=price;
    let gain = r;
    if(Array.isArray(r)){
      const min = r[0], max = r[1];
      gain = Math.floor(Math.random()*(max-min+1)+min);
    }
    rendaPassiva += gain;
    alert(`Investimento adquirido. Renda passiva adicionada: ${gain} por ${passiveIntervalMs/1000}s`);
    addLog(`Investimento comprado por ${price.toLocaleString()} â€” Retorno ${gain}`);
    atualizar();
  } else alert('Dinheiro insuficiente');
} 

// EmprÃ©stimos: pedir e pagar
function takeLoan(amount){
  if(!amount || amount <= 0) return alert('Valor invÃ¡lido');
  dinheiro += amount;
  emprestimo += Math.ceil(amount);
  emprestimoTakenAt = Date.now(); // grava o momento do emprÃ©stimo
  addLog(`EmprÃ©stimo concedido: ${amount.toLocaleString()} â€” vocÃª poderÃ¡ pagar em ~5 minutos`);
  salvar();
  atualizar();
}
function requestLoan(){
  const v = Number(document.getElementById('loanAmountInput').value);
  if(!v || v<=0) return alert('Valor invÃ¡lido');
  // limite: mÃ¡ximo 50% do dinheiro atual
  const cap = Math.floor(dinheiro * 0.5);
  if(cap <= 0) return alert('VocÃª nÃ£o tem saldo suficiente para solicitar emprÃ©stimo (limite: 0)');
  if(v > cap){ return alert(`Limite excedido. VocÃª pode pedir no mÃ¡ximo ${cap.toLocaleString()} (50% do seu saldo atual)`); }
  takeLoan(v);
  document.getElementById('loanAmountInput').value = '';
}
function repayLoan(amount){
  const pay = Math.ceil(Number(amount) || 0);
  if(pay <= 0) return;
  if(emprestimo <= 0) return alert('VocÃª nÃ£o possui emprÃ©stimos para pagar');
  // verificar cooldown de 5 minutos (300000ms)
  const now = Date.now();
  if(now - (emprestimoTakenAt || 0) < 300000) {
    const remain = 300000 - (now - (emprestimoTakenAt || 0));
    const mm = Math.floor(remain / 60000);
    const ss = Math.floor((remain % 60000) / 1000);
    return alert(`VocÃª sÃ³ poderÃ¡ pagar o emprÃ©stimo em ${mm}m ${ss}s`);
  }
  if(dinheiro < pay) return alert('Dinheiro insuficiente para pagar esse valor');
  dinheiro -= pay;
  emprestimo -= pay;
  if(emprestimo < 0) emprestimo = 0;
  if(emprestimo === 0) emprestimoTakenAt = 0; // reset cooldown quando quitado
  addLog(`Pagamento de emprÃ©stimo: ${pay.toLocaleString()}`);
  salvar();
  atualizar();
}
function repayLoanInput(){
  const v = Number(document.getElementById('loanRepayInput').value);
  if(!v || v<=0) return alert('Valor invÃ¡lido');
  repayLoan(v);
  document.getElementById('loanRepayInput').value = '';
}
function isLockedHouse(name){
  const els = document.querySelectorAll('.endgame');
  for(const el of els){
    if(el.innerHTML.includes(name)){
      const req = Number(el.getAttribute('data-required')||0);
      return prestigios < req ? req : 0;
    }
  }
  return 0;
}
function comprarCasa(name,c,r){
  const lockReq = isLockedHouse(name);
  if(lockReq){ return alert(`Esta casa estÃ¡ bloqueada. Requer ${lockReq} medalhas.`); }
  const price = applyDiscount(c);
  if(dinheiro>=price){
    dinheiro-=price;
    let gain = r;
    if(Array.isArray(r)){
      const min = r[0], max = r[1];
      gain = Math.floor(Math.random()*(max-min+1)+min);
    }
    rendaPassiva += gain;
    casasCompradas.push({nome:name,preco:price,retorno:gain});
    addLog(`Casa comprada: ${name} â€” Retorno ${gain} por ${passiveIntervalMs/1000}s`);
    alert(`VocÃª comprou ${name}. Renda passiva: ${gain} por ${passiveIntervalMs/1000}s`);
    atualizar();
  } else alert('Dinheiro insuficiente');
}
function comprarVeiculo(n,p){ const price = applyDiscount(p); if(dinheiro>=price){dinheiro-=price;veiculosComprados.push({nome:n,preco:price});atualizar();}else alert('Dinheiro insuficiente'); } 
function abrir(id){painelPrincipal.classList.add('hidden');document.getElementById(id).classList.remove('hidden'); if(id === 'loja') mostrarLojaTab('veiculos'); }
function voltar(){document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));painelPrincipal.classList.remove('hidden');}
function mostrarGaleria(t){
  let h='';
  if(t==='veiculos'){
    veiculosComprados.forEach(v=>h+=`ğŸš— ${v.nome} - ${v.preco}<br>`);
  } else if(t==='casas'){
    casasCompradas.forEach(c=>h+=`ğŸ  ${c.nome} - ${c.preco}<br>`);
  } else if(t==='itens'){
    galleryItems.forEach(it=>{
      if(it.type === 'cofre') h += `ğŸ—ï¸ ${it.name} â€” adquirido em ${new Date(it.ts).toLocaleString()}<br>`;
      else h += `${it.name ? it.name : it.type}<br>`;
    });
  }
  listaGaleria.innerHTML = h || 'Nenhum item registrado';
}

function mostrarLojaTab(tab){
  const v = document.getElementById('lojaVeiculos');
  const c = document.getElementById('lojaCaixas');
  if(tab === 'veiculos'){ v.classList.remove('hidden'); c.classList.add('hidden'); }
  else { v.classList.add('hidden'); c.classList.remove('hidden'); }
}

// buyBox: cost 5,000,000 â€” probabilities: 60% 500k, 35% potion +25% clique (2min), 4.5% 250k, 0.5% cofre de ouro
function buyBox(){
  const cost = 5000000;
  if(dinheiro < cost) return alert('Dinheiro insuficiente para comprar a caixa');
  dinheiro -= cost; atualizar();
  const r = Math.random() * 100;
  const resultEl = document.getElementById('boxResult');
  if(r < 60){ dinheiro += 500000; resultEl.innerText = 'VocÃª ganhou 500.000!'; }
  else if(r < 95){ // 60 + 35
    const expires = Date.now() + 2*60*1000; // 2 minutos
    // nÃ£o empilhar: se jÃ¡ houver um buff 'click', renovamos/atualizamos; caso contrÃ¡rio, criamos
    const existing = activeBuffs.find(b => b.type === 'click');
    if(existing){ existing.mul = 0.25; existing.expires = expires; }
    else { activeBuffs.push({type:'click', mul:0.25, expires:expires}); }
    resultEl.innerText = 'VocÃª ganhou uma PoÃ§Ã£o: +25% renda por clique por 2 minutos! (nÃ£o acumulativa)';
  }
  else if(r < 99.5){ dinheiro += 250000; resultEl.innerText = 'VocÃª ganhou 250.000!'; }
  else { // cofre de ouro
    const it = {type:'cofre', name:'Cofre de Ouro', ts: Date.now()};
    galleryItems.push(it);
    // aplicar bÃ´nus permanente
    permanentItemBonuses.passive = (permanentItemBonuses.passive || 0) + 0.20;
    permanentItemBonuses.click = (permanentItemBonuses.click || 0) + 0.10;
    resultEl.innerText = 'VocÃª encontrou um Cofre de Ouro! Ele foi adicionado Ã  sua Galeria.';
    addLog('Cofre de Ouro adquirido â€” +20% renda passiva (permanente), +10% renda por clique (permanente)');
  }
  salvar(true); atualizar();
}

// cleanup buffs (remove expired)
function cleanupBuffs(){
  const now = Date.now();
  activeBuffs = activeBuffs.filter(b => !b.expires || b.expires > now);
}

function getClickBuffMultiplier(){
  cleanupBuffs();
  // NÃ£o acumulamos buffs de poÃ§Ã£o; consideramos apenas o maior multiplicador ativo
  const clickBuffs = activeBuffs.filter(b => b.type === 'click' && b.mul);
  const maxMul = clickBuffs.reduce((m,b)=> Math.max(m, b.mul || 0), 0);
  return 1 + (permanentItemBonuses.click || 0) + maxMul;
}

// (Trecho antigo de trade removido â€” trade agora usa o motor de mercado contÃ­nuo)
/* =========================
   SAVE / LOAD + OFFLINE
   ========================= */

const OFFLINE_LIMIT = 24 * 60 * 60 * 1000; // 24h

// renda passiva e juros (usar intervalo variÃ¡vel)
function setupPassiveInterval(){
  if(passiveIntervalId) clearInterval(passiveIntervalId);
  passiveIntervalId = setInterval(()=>{
    // aplicar renda passiva com multiplicadores (prestÃ­gio e compra global)
    const globalMul = prestigeShop.globalMultiplier ? 1.10 : 1;
    const passiveBoostMul = prestigeShop.passiveBoost ? 1.20 : 1;
    const ganho = Math.floor(rendaPassiva * getPrestigeMultiplier() * passiveBoostMul * globalMul * (1 + (permanentItemBonuses.passive || 0)));
    dinheiro += ganho; // incluir bÃ´nus permanentes de itens (ex: Cofre de Ouro)
    // aplicar juros do emprÃ©stimo apenas enquanto o jogo estÃ¡ ativo
    if(emprestimo > 0){
      emprestimo = Math.ceil(emprestimo * (1 + emprestimoTaxa));
    }
    atualizar();
  }, passiveIntervalMs);
}
// iniciar intervalo padrÃ£o
setupPassiveInterval();
// acompanhar tempo de jogo total
setInterval(()=>{ playTimeMs += 1000; }, 1000);

let __lastSaveAt = 0; const __saveThrottleMs = 2000; // limite mÃ­nimo entre gravaÃ§Ãµes
let __saveCorrupted = false;
function salvar(force = false){
  // se o save local foi marcado como corrompido, NÃƒO sobrescrevemos automaticamente
  if(__saveCorrupted && !force){
    console.warn('Save local marcado como corrompido; aÃ§Ã£o manual necessÃ¡ria para sobrescrever');
    const el = document.getElementById('saveStatus'); if(el) el.innerText = 'Save local corrompido â€” aÃ§Ã£o manual necessÃ¡ria';
    return;
  }
  // throttle simples: evita gravar em localStorage muitas vezes por segundo
  if(!force && Date.now() - __lastSaveAt < __saveThrottleMs) return;
  const payload = {
    dinheiro,
    renda,
    nivel,
    rendaPassiva,
    custoUpgrade,
    veiculosComprados,
    casasCompradas,
    marketPriceVal,
    prestigios,
    emprestimo,
    emprestimoTaxa,
    emprestimoTakenAt,
    prestigeShop,
    passiveIntervalMs,
    galleryItems,
    permanentItemBonuses,
    activeBuffs,
    playerName,
    playTimeMs,
    playerOptOut,
    lastSave: Date.now()
  };
  try{
    console.debug('payload de save a ser gravado:', payload);
    localStorage.setItem('save', JSON.stringify(payload));
    __lastSaveAt = Date.now();
    __saveCorrupted = false; // gravaÃ§Ã£o bem sucedida corrige o estado
    const el = document.getElementById('saveStatus');
    if(el) el.innerText = 'Ãšltimo save: ' + new Date(__lastSaveAt).toLocaleString();
    // para depuraÃ§Ã£o silenciosa
    console.info('Save salvo em', new Date(__lastSaveAt).toISOString());
    // envio automÃ¡tico para rankings ao salvar forÃ§ado, respeitando opt-out
    if(playerName && !playerOptOut && force){ try{ autoUpdateRankings(); }catch(e){ console.warn('Erro no autoUpdateRankings', e); } }
  }catch(e){
    console.error('Erro ao salvar', e);
    alert('NÃ£o foi possÃ­vel salvar localmente: ' + (e && e.message ? e.message : e));
  }
} 

function carregar(){
  const raw = localStorage.getItem('save');
  console.info('carregar(): conteÃºdo bruto do save:', raw);
  if(!raw) return;

  try{
    const s = JSON.parse(raw);
    // ValidaÃ§Ã£o simples: garantir que o objeto tem a estrutura mÃ­nima
    if(!s || typeof s !== 'object' || (typeof s.dinheiro === 'undefined' && typeof s.lastSave === 'undefined')){
      throw new Error('Formato de save invÃ¡lido');
    }

    dinheiro = typeof s.dinheiro === 'number' ? s.dinheiro : (s.dinheiro ? Number(s.dinheiro) : 0);
    renda = s.renda || 1;
    nivel = s.nivel || 1;
    rendaPassiva = s.rendaPassiva || 0;
    custoUpgrade = s.custoUpgrade || 100;
    veiculosComprados = s.veiculosComprados || [];
    casasCompradas = s.casasCompradas || [];
    marketPriceVal = s.marketPriceVal || initialPrice;
    prestigios = s.prestigios || 0;
    // carregar estado de emprÃ©stimo
    emprestimo = s.emprestimo || 0;
    emprestimoTaxa = typeof s.emprestimoTaxa === 'number' ? s.emprestimoTaxa : emprestimoTaxa;
    emprestimoTakenAt = s.emprestimoTakenAt || 0;
    // carregar loja de prestÃ­gios e intervalos
    prestigeShop = s.prestigeShop || prestigeShop;
    passiveIntervalMs = s.passiveIntervalMs || passiveIntervalMs;
    // carregar itens e buffs
    galleryItems = s.galleryItems || galleryItems;
    permanentItemBonuses = s.permanentItemBonuses || permanentItemBonuses;
    activeBuffs = (s.activeBuffs || []).filter(b => !b.expires || b.expires > Date.now());
    playerOptOut = !!s.playerOptOut;
    if(prestigeShop.autoClicker) startAutoClicker();

    // carregar nome do jogador e tempo de jogo (se existir)
    playerName = typeof s.playerName === 'string' ? s.playerName : '';
    playerNameSet = !!s.playerName || !!localStorage.getItem('playerNameChosen');
    playTimeMs = s.playTimeMs || 0;
    sessionStart = Date.now();

    /* ===== GANHOS OFFLINE ===== */
    if(s.lastSave){
      const agora = Date.now();
      let tempoOffline = Math.min(agora - s.lastSave, OFFLINE_LIMIT);
      const ciclos = Math.floor(tempoOffline / 30000);
      const ganhoOffline = ciclos * Math.floor(rendaPassiva * (1 + ((s.prestigios || 0) * 0.02)));
      dinheiro += ganhoOffline;
    }

    // carregado com sucesso â€” limpar flag de corrompido e atualizar status
    __saveCorrupted = false;
    const el = document.getElementById('saveStatus'); if(el) el.innerText = 'Ãšltimo save: ' + new Date(s.lastSave||Date.now()).toLocaleString();

    // atualiza timestamp para prevenir exploit
    salvar(true);

    // perguntar nome do jogador apenas uma vez (se ainda nÃ£o tivermos perguntado)
    if(!localStorage.getItem('playerNameChosen') && !playerName){ ensurePlayerName(); }
    // carregar leaderboards locais e mostrar pÃ¡gina padrÃ£o
    loadLeaderboards();
    renderRankingTab('money');

  }catch(e){
    console.warn('Save invÃ¡lido', e);
    // preservar o conteÃºdo corrompido para anÃ¡lise e impedir sobrescrita automÃ¡tica
    try{
      const key = 'save_corrupted_' + Date.now();
      localStorage.setItem(key, raw);
      __saveCorrupted = true;
      const el = document.getElementById('saveStatus'); if(el) el.innerText = 'Save local corrompido â€” ' + key + ' preservado';
      alert('Save local detectado como corrompido. Criei uma cÃ³pia em "' + key + '" para preservaÃ§Ã£o. Importe um backup ou clique em "Salvar Agora" para sobrescrever.');
    }catch(err){ console.error('Erro ao preservar save corrompido', err); }
  }
}



function exportarSave(){
  salvar(true);
  const data = localStorage.getItem('save');
  if(!data){ alert('Nenhum save encontrado para exportar'); return; }
  try{
    const blob = new Blob([data],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'sim_save.json'; a.click();
    URL.revokeObjectURL(url);
  }catch(e){ console.error('Erro ao exportar', e); alert('Erro ao exportar: ' + (e && e.message ? e.message : e)); }
}

 
function importarSave(e){
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = () => {
    try{
      const s = JSON.parse(r.result);
      dinheiro = s.dinheiro || 0; renda = s.renda || 1; nivel = s.nivel || 1; rendaPassiva = s.rendaPassiva || 0; custoUpgrade = s.custoUpgrade || 100;
      veiculosComprados = s.veiculosComprados || []; casasCompradas = s.casasCompradas || [];
      marketPriceVal = s.marketPriceVal || initialPrice; priceHistory = Array(historyMax).fill(marketPriceVal);
      galleryItems = s.galleryItems || [];
      permanentItemBonuses = s.permanentItemBonuses || {passive:0,click:0};
      activeBuffs = (s.activeBuffs || []).filter(b => !b.expires || b.expires > Date.now());
      playerName = s.playerName || '';
      if(s.playerName) localStorage.setItem('playerNameChosen','1');
      // registrar nome importado como escolhido (Ãºnico localmente)
      if(playerName){ loadChosenNames(); if(!chosenNames.some(n=>n.toLowerCase()===playerName.toLowerCase())){ chosenNames.push(playerName); saveChosenNames(); } }
      playerOptOut = !!s.playerOptOut;
      playTimeMs = s.playTimeMs || 0;
      salvar(true); atualizar(); alert('Save importado com sucesso!');
    }catch(err){ alert('Arquivo invÃ¡lido'); }
  };
  r.readAsText(f); e.target.value = '';
}
function apagarSave(){if(confirm('Apagar save?')){localStorage.removeItem('save');dinheiro=0;renda=1;nivel=1;rendaPassiva=0;custoUpgrade=100;prestigios=0;veiculosComprados=[];casasCompradas=[];marketPriceVal = initialPrice; priceHistory = Array(historyMax).fill(marketPriceVal); // reset loan state as well
    emprestimo = 0; emprestimoTakenAt = 0; emprestimoTaxa = 0.02; atualizar();alert('Save apagado e dÃ­vida zerada');} }

// ------------------
// Player & Rankings
// ------------------
function ensurePlayerName(){
  // perguntar apenas uma vez por usuÃ¡rio (persistido em localStorage)
  if(localStorage.getItem('playerNameChosen')) return;
  loadChosenNames();
  while(true){
    const name = prompt('Bem-vindo! Escolha seu nome (apenas uma vez):');
    if(name === null){ playerName = ''; localStorage.setItem('playerNameChosen','1'); salvar(true); return; }
    const trimmed = name.trim().substring(0,20);
    if(!trimmed){ alert('Nome invÃ¡lido. Tente novamente.'); continue; }
    // unicidade case-insensitive
    const exists = chosenNames.some(n => n.toLowerCase() === trimmed.toLowerCase());
    if(exists){ alert('Nome jÃ¡ existe. Por favor escolha outro (ex: ' + trimmed + '1)'); continue; }
    // vÃ¡lido e Ãºnico
    playerName = trimmed;
    chosenNames.push(playerName);
    saveChosenNames();
    localStorage.setItem('playerNameChosen','1');
    salvar(true);

    return;
  }
}

function definePlayerName(){
  // Permite ao usuÃ¡rio definir/alterar o nome a partir das configuraÃ§Ãµes
  loadChosenNames();
  const name = prompt('defina seu nome');
  if(name === null) return; // cancelou
  const trimmed = name.trim().substring(0,20);
  if(!trimmed){ alert('Nome invÃ¡lido.'); return; }
  // unicidade: permite manter o prÃ³prio nome, mas impede escolher nome jÃ¡ usado por outro
  const exists = chosenNames.some(n => n.toLowerCase() === trimmed.toLowerCase());
  if(exists && (!playerName || trimmed.toLowerCase() !== playerName.toLowerCase())){ alert('Nome jÃ¡ existe. Escolha outro.'); return; }
  if(!exists) { chosenNames.push(trimmed); saveChosenNames(); }
  playerName = trimmed;
  localStorage.setItem('playerNameChosen','1');
  salvar(true);
  renderSettings();
  alert('Nome definido: ' + playerName);
}  

function loadLeaderboards(){
  try{ leaderboards = JSON.parse(localStorage.getItem('leaderboards') || '{"money":[],"time":[]}'); }catch(e){ leaderboards = {money:[], time:[]}; }
}
function saveLeaderboards(){ localStorage.setItem('leaderboards', JSON.stringify(leaderboards)); }

function loadChosenNames(){
  try{ chosenNames = JSON.parse(localStorage.getItem('chosenNames') || '[]'); }catch(e){ chosenNames = []; }
}
function saveChosenNames(){ localStorage.setItem('chosenNames', JSON.stringify(chosenNames)); }

function submitToLeaderboards(){
  if(!playerName){ ensurePlayerName(); if(!playerName){ alert('Nome nÃ£o definido; nÃ£o foi possÃ­vel enviar para o ranking'); return; } }
  if(playerOptOut){ alert('VocÃª optou por nÃ£o entrar nos rankings. Desative essa opÃ§Ã£o nas ConfiguraÃ§Ãµes para enviar.'); return; }
  const moneyVal = dinheiro;
  const timeVal = playTimeMs + (Date.now() - sessionStart);
  const upsert = (arr, val)=>{
    const idx = arr.findIndex(x=>x.name === playerName);
    if(idx >= 0) arr[idx] = {name: playerName, val}; else arr.push({name: playerName, val});
    arr.sort((a,b)=> b.val - a.val);
    if(arr.length>10) arr.length = 10; // manter top 10
  };
  upsert(leaderboards.money, moneyVal);
  upsert(leaderboards.time, timeVal);
  saveLeaderboards();
  renderRankingTab(currentRankingTab||'money');
  alert('Enviado para rankings!');
}

function mostrarRankingsTab(tab){ document.getElementById('rankings').classList.remove('hidden'); document.getElementById('loja').classList.add('hidden'); mostrarLojaTab('veiculos'); renderRankingTab(tab); }

function renderRankingTab(tab){ currentRankingTab = tab || 'money'; const el = document.getElementById('rankList'); if(!el) return; const items = (leaderboards[tab]||[]).slice(0,10); let h = '<ol>'; items.forEach(it=>{ const val = tab === 'money' ? (it.val).toLocaleString() : formatTime(it.val); h += `<li>${escapeHtml(it.name)} â€” ${val}</li>`; }); h += '</ol>'; el.innerHTML = h; renderSettings(); const noteEl = document.getElementById('rankNote'); if(noteEl){ noteEl.innerText = playerName ? `Seu nome: ${playerName} (definido apenas uma vez).` : 'VocÃª ainda nÃ£o definiu um nome.'; } }

function renderSettings(){ const nameEl = document.getElementById('settingsName'); const moneyEl = document.getElementById('settingsMoney'); const chk = document.getElementById('optOutCheckbox'); if(nameEl) nameEl.innerText = playerName || '-'; if(moneyEl) moneyEl.innerText = (dinheiro || 0).toLocaleString(); if(chk){ chk.checked = !!playerOptOut; chk.onchange = toggleOptOut; } }

function toggleOptOut(){ playerOptOut = !!document.getElementById('optOutCheckbox').checked; salvar(true); if(playerOptOut){ removePlayerFromLeaderboards(); saveLeaderboards(); renderRankingTab(currentRankingTab||'money'); } }

function removePlayerFromLeaderboards(){ if(!playerName) return; ['money','time'].forEach(k=>{ leaderboards[k] = (leaderboards[k]||[]).filter(x=> x.name.toLowerCase() !== playerName.toLowerCase()); }); }

function autoUpdateRankings(){ // executa a cada 2 minutos
  if(!playerName || playerOptOut) return;
  loadLeaderboards();
  const moneyVal = dinheiro;
  const timeVal = playTimeMs + (Date.now() - sessionStart);
  const upsert = (arr, val)=>{
    const idx = arr.findIndex(x=>x.name === playerName);
    if(idx >= 0) arr[idx] = {name: playerName, val}; else arr.push({name: playerName, val});
    arr.sort((a,b)=> b.val - a.val);
    if(arr.length>10) arr.length = 10;
  };
  upsert(leaderboards.money, moneyVal);
  upsert(leaderboards.time, timeVal);
  saveLeaderboards();
  renderRankingTab(currentRankingTab||'money');
}

// iniciar auto-update a cada 2 minutos
setInterval(autoUpdateRankings, 2*60*1000);

function formatTime(ms){ const s = Math.floor(ms/1000); const h = Math.floor(s/3600); const m = Math.floor((s%3600)/60); const sec = s%60; return (h>0?h+'h ':'') + (m>0?m+'m ':'') + sec+'s'; }
function escapeHtml(str){ return String(str).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* Tutorial inicial (mostra apenas na primeira vez) */
const tutorialSteps = [
  'Bem-vindo ao Simulador de NegÃ³cios! Clique em "Ganhar dinheiro" para obter sua primeira renda.',
  'Use "Upgrade" para aumentar sua renda por clique e subir de nÃ­vel.',
  'Acesse "Investimentos" para comprar ativos que geram renda passiva automaticamente.',
  'Na aba "GrÃ¡ficos" vocÃª pode abrir trades de alto risco; use as setas para abrir e "Fechar Trade" para encerrar.',
  'Abra "Loja" e "Galeria" para comprar itens e ver suas compras. Boa sorte!'
];
let tutorialIndex = 0;
function renderTutorial(){
  const tutorialOverlay = document.getElementById('tutorialOverlay');
  const tutorialStepsEl = document.getElementById('tutorialSteps');
  const tutorialProg = document.getElementById('tutorialProgress');
  const prevBtn = document.querySelector('.tutorialBtn.secondary');
  const nextBtn = document.querySelector('.tutorialBtn:not(.secondary)');
  const skipBtn = document.getElementById('tutorialSkip');
  if(!tutorialOverlay || !tutorialStepsEl || !tutorialProg) return;
  tutorialStepsEl.innerText = tutorialSteps[tutorialIndex];
  tutorialProg.innerText = `Passo ${tutorialIndex+1} de ${tutorialSteps.length}`;
  prevBtn.disabled = tutorialIndex===0;
  if(tutorialIndex === tutorialSteps.length - 1){
    nextBtn.style.display = 'none';
    skipBtn.textContent = 'ComeÃ§ar';
  }else{
    nextBtn.style.display = '';
    skipBtn.textContent = 'Pular';
  }
}
function showTutorial(force=false){
  if(!force && localStorage.getItem('tutorial_seen')) return;
  tutorialIndex = 0;
  const tutorialOverlay = document.getElementById('tutorialOverlay');
  if(!tutorialOverlay) return;
  tutorialOverlay.classList.remove('hidden');
  renderTutorial();
}
function nextTutorial(){ if(tutorialIndex < tutorialSteps.length - 1){ tutorialIndex++; renderTutorial(); } else closeTutorial(true); }
function prevTutorial(){ if(tutorialIndex>0){ tutorialIndex--; renderTutorial(); } }
function closeTutorial(markSeen=false){
  const tutorialOverlay = document.getElementById('tutorialOverlay');
  if(tutorialOverlay) tutorialOverlay.classList.add('hidden');
  if(markSeen) localStorage.setItem('tutorial_seen','1');
}

function startGame(){
  // Fecha o tutorial e marca como visto
  closeTutorial(true);
  // DÃ¡ um pequeno bÃ´nus inicial apenas uma vez
  if(!localStorage.getItem('tutorial_bonus_given')){
    dinheiro += 10;
    atualizar();
    localStorage.setItem('tutorial_bonus_given','1');
  }
  // Foca no botÃ£o de ganhar dinheiro para orientar o jogador
  const btn = document.querySelector('button[onclick="ganharDinheiro()"]');
  if(btn) btn.focus();
}

// === AtualizaÃ§Ãµes / Logs ===
function addLog(msg){
  const logs = JSON.parse(localStorage.getItem('update_logs')||'[]');
  logs.unshift({msg:msg, ts: Date.now()});
  localStorage.setItem('update_logs', JSON.stringify(logs));
  renderLogs();
}

function seedUpdateLogs(){
  const version = '2025-12-31-1';
  if(localStorage.getItem('update_version') === version) return;
  addLog('AtualizaÃ§Ã£o: PoÃ§Ã£o agora dura 2 minutos; buffs nÃ£o acumulam; sistema de Caixas adicionado.');
  addLog('Rankings: abas Dinheiro e Tempo adicionadas; atualizaÃ§Ã£o automÃ¡tica a cada 2 minutos; top 10 mantido.');
  addLog('ConfiguraÃ§Ãµes: agora vocÃª pode definir seu nome manualmente; opÃ§Ã£o de excluir-se dos rankings (opt-out).');
  addLog('Envio automÃ¡tico para ranking ao salvar forÃ§ado ativado.');
  localStorage.setItem('update_version', version);
}
function renderLogs(){
  const fullEl = document.getElementById('updateLogsList');
  if(!fullEl) return;
  const logs = JSON.parse(localStorage.getItem('update_logs')||'[]');
  const readAt = Number(localStorage.getItem('logs_read_at')||0);
  fullEl.innerHTML = logs.map(l=>{
    const date = new Date(l.ts).toLocaleString();
    const isNew = l.ts > readAt ? '<span class="changelog-new">Novo</span>' : '';
    return `<div class="changelog-item">${isNew}<div style="font-size:13px;color:#ddd">${date}</div><div>${l.msg}</div></div>`;
  }).join('') || '<div class="changelog-item">Nenhuma atualizaÃ§Ã£o registrada</div>';
}
function markLogsRead(){
  localStorage.setItem('logs_read_at', Date.now());
  renderLogs();
}
function dismissAnnouncement(){
  const el = document.getElementById('announcementBar');
  if(el) el.classList.add('hidden');
  localStorage.setItem('announcement_dismissed','1');
  markLogsRead();
}
function requiredForNextPrestige(){ return (prestigios + 1) * 1000000; }
function attemptPrestige(){
  const req = requiredForNextPrestige();
  if(dinheiro < req) return alert(`VocÃª precisa de ${req.toLocaleString()} para prestigiar.`);
  if(!confirm(`Prestigiar resetarÃ¡ seu progresso e concederÃ¡ 1 medalha. Deseja prosseguir? (Requisito: ${req.toLocaleString()})`)) return;
  prestigios++;
  // atualizar log com novo formato de bÃ´nus (5% por prestÃ­gio)
  addLog(`PrestÃ­gio alcanÃ§ado! Medalhas: ${prestigios} â€” +${(prestigios*5)}% em renda por clique e passiva`);
  // remover dÃ­vida ao prestigiar
  if(emprestimo && emprestimo > 0){
    emprestimo = 0; emprestimoTakenAt = 0; emprestimoTaxa = 0.02;
    addLog('DÃ­vida de emprÃ©stimo anulada ao prestigiar.');
  }

  // reset bÃ¡sico (mantÃ©m medalhas e compras na loja de prestÃ­gios)
  dinheiro = 0; renda = 1; nivel = 1; rendaPassiva = 0; custoUpgrade = 100;
  veiculosComprados = []; casasCompradas = [];
  marketPriceVal = initialPrice; priceHistory = Array(historyMax).fill(marketPriceVal);
  salvar();
  renderPrestigios();
  updateEndgameUnlocks();
  atualizar();
  alert('PrestÃ­gio realizado! VocÃª recebeu 1 medalha.');
}
function renderPrestigios(){
  const elCount = document.getElementById('prestigeCount');
  const elBonus = document.getElementById('prestigeBonus');
  const elReq = document.getElementById('prestigeReq');
  const elMedals = document.getElementById('medals');
  const medalRow = document.getElementById('medalRow');
  const previewEl = document.getElementById('prestigePreview');
  const btn = document.getElementById('prestigeBtn');
  const req = requiredForNextPrestige();
  // atualizar a UI da loja de prestÃ­gios
  const buyAutoBtn = document.getElementById('buyAutoClicker');
  const buyPassiveBtn = document.getElementById('buyPassiveBoost');
  const buySpeedBtn = document.getElementById('buyPassiveSpeed');
  const buyDiscountBtn = document.getElementById('buyDiscount');
  const buyGlobalBtn = document.getElementById('buyGlobalMul');
  const speedCountEl = document.getElementById('passiveSpeedCount');

  if(buyAutoBtn) { buyAutoBtn.disabled = prestigeShop.autoClicker || prestigios < 2; buyAutoBtn.textContent = prestigeShop.autoClicker ? 'Comprado' : 'Comprar'; }
  if(buyPassiveBtn) { buyPassiveBtn.disabled = prestigeShop.passiveBoost || prestigios < 2; buyPassiveBtn.textContent = prestigeShop.passiveBoost ? 'Comprado' : 'Comprar'; }
  if(buySpeedBtn) { buySpeedBtn.disabled = prestigeShop.passiveSpeedCount >= 5 || prestigios < 1; buySpeedBtn.textContent = (prestigeShop.passiveSpeedCount >=5) ? 'MÃ¡ximo' :'Comprar'; }
  if(speedCountEl) speedCountEl.innerText = `(${prestigeShop.passiveSpeedCount}/5)`;
  if(buyDiscountBtn) { buyDiscountBtn.disabled = prestigeShop.discount || prestigios < 5; buyDiscountBtn.textContent = prestigeShop.discount ? 'Comprado' : 'Comprar'; }
  if(buyGlobalBtn) { buyGlobalBtn.disabled = prestigeShop.globalMultiplier || prestigios < 3; buyGlobalBtn.textContent = prestigeShop.globalMultiplier ? 'Comprado' : 'Comprar'; }


  if(elCount) elCount.innerText = prestigios;
  if(elBonus) elBonus.innerText = (prestigios*2) + '%';
  if(elReq) elReq.innerText = req.toLocaleString();
  if(elMedals) elMedals.innerText = prestigios;

  if(medalRow){
    if(prestigios === 0){ medalRow.innerHTML = '<span style="color:#ccc">Nenhuma medalha ainda</span>'; }
    else{
      let html = '';
      for(let i=1;i<=prestigios;i++) html += `<span title="Medalha ${i}" style="font-size:20px;margin-right:6px">ğŸ…</span>`;
      medalRow.innerHTML = html;
    }
  }

  if(previewEl){
    const currentBonus = prestigios * 2;
    const nextBonus = (prestigios + 1) * 2;
    const nextMedals = prestigios + 1;
    const nextReqAfter = (prestigios + 2) * 1000000;
    const canPrestige = dinheiro >= req;

    previewEl.innerHTML = `
      <div>Ao prestigiar agora: <strong>+2% por prestÃ­gio</strong> â†’ bÃ´nus: <strong>${currentBonus}% â†’ ${nextBonus}%</strong></div>
      <div style="margin-top:6px">Medalhas apÃ³s prestigiar: <strong>${nextMedals}</strong></div>
      <div style="margin-top:6px">Requisito atual: <strong>${req.toLocaleString()}</strong> â€” PrÃ³ximo requisito apÃ³s prestigiar: <strong>${nextReqAfter.toLocaleString()}</strong></div>
      <div style="margin-top:6px;color:${canPrestige ? '#0f0' : '#f33'}">${canPrestige ? 'VocÃª pode prestigiar agora.' : 'VocÃª ainda nÃ£o tem dinheiro suficiente para prestigiar.'}</div>
    `;
  }

  if(btn){
    btn.textContent = `Prestigiar (Requisito: ${req.toLocaleString()})`;
    btn.disabled = dinheiro < req;
  }
  // mostrar bÃ´nus atual e limitar no preview
  if(elBonus) elBonus.innerText = Math.round((getPrestigeMultiplier()-1)*100) + '% (mÃ¡x 50%)';
  // salvar alteraÃ§Ãµes de shop/status
  salvar();
}

function buyPrestigeItem(item){
  if(item === 'autoClicker'){
    if(prestigios < 2) return alert('Medalhas insuficientes');
    if(prestigeShop.autoClicker) return alert('JÃ¡ comprado');
    prestigios -= 2; prestigeShop.autoClicker = true; addLog('Auto Clicker comprado â€” cliques automÃ¡ticos ativados (0.5s)');
    startAutoClicker();
  } else if(item === 'passiveBoost'){
    if(prestigios < 2) return alert('Medalhas insuficientes');
    if(prestigeShop.passiveBoost) return alert('JÃ¡ comprado');
    prestigios -= 2; prestigeShop.passiveBoost = true; addLog('+20% de renda passiva comprado');
  } else if(item === 'passiveSpeed'){
    if(prestigios < 1) return alert('Medalhas insuficientes');
    if(prestigeShop.passiveSpeedCount >= 5) return alert('JÃ¡ atingiu o mÃ¡ximo de reduÃ§Ãµes de intervalo');
    prestigios -= 1; prestigeShop.passiveSpeedCount += 1; passiveIntervalMs = Math.max(20000, passiveIntervalMs - 2000); setupPassiveInterval(); addLog('ReduÃ§Ã£o de intervalo de renda passiva adquirida (-2s)');
  } else if(item === 'discount'){
    if(prestigios < 5) return alert('Medalhas insuficientes');
    if(prestigeShop.discount) return alert('JÃ¡ comprado');
    prestigios -= 5; prestigeShop.discount = true; addLog('Desconto permanente de 10% adquirido');
  } else if(item === 'globalMultiplier'){
    if(prestigios < 3) return alert('Medalhas insuficientes');
    if(prestigeShop.globalMultiplier) return alert('JÃ¡ comprado');
    prestigios -= 3; prestigeShop.globalMultiplier = true; addLog('Multiplicador global +10% para clickers e investimentos adquirido');
  }
  renderPrestigios();
  atualizar();
}

function startAutoClicker(){
  if(autoClickerIntervalId) return;
  autoClickerIntervalId = setInterval(()=>{
    if(prestigeShop.autoClicker) ganharDinheiro(); else stopAutoClicker();
  }, 500);
}
function stopAutoClicker(){ if(autoClickerIntervalId){ clearInterval(autoClickerIntervalId); autoClickerIntervalId = null; } }
function updateEndgameUnlocks(){
  document.querySelectorAll('.endgame').forEach(el=>{
    const req = Number(el.getAttribute('data-required') || 0);
    const btn = el.querySelector('button');
    if(prestigios >= req){
      el.classList.remove('locked');
      if(btn) { btn.disabled = false; btn.style.opacity = 1; btn.textContent = 'Comprar'; }
    } else {
      el.classList.add('locked');
      if(btn) { btn.disabled = true; btn.style.opacity = 0.5; btn.textContent = `Bloqueado - Requer ${req} medalhas`; }
    }
  });
}

function initLogs(){
  const key = 'update_logs';
  // substituir todas as logs antigas pelas mensagens atuais
  const seed = [
    {msg:'Adicionados 5 novos veÃ­culos: XE, BMW 320i, Audi A3, Toyota Corolla, Honda Civic', ts: Date.now()},
    {msg:'Adicionadas 5 novas casas (Studio, Casa Moderna, Townhouse, Fazenda, Villa)', ts: Date.now() - 1000*60*60},
    {msg:'Sistema de EmprÃ©stimos adicionado â€” peÃ§a emprÃ©stimos com juros e pague quando desejar', ts: Date.now() - 1000*60*60*2},
    {msg:'Logs reiniciados â€” antigas entradas removidas e substituÃ­das pelas mensagens atuais', ts: Date.now() - 1000*60*60*3}
  ];
  localStorage.setItem(key, JSON.stringify(seed));
  // marcar como nÃ£o lidas para que o jogador veja as atualizaÃ§Ãµes
  localStorage.setItem('logs_read_at','0');

  // oculta anÃºncio se jÃ¡ dispensado anteriormente
  const ann = localStorage.getItem('announcement_dismissed');
  if(ann === '1'){
    const el = document.getElementById('announcementBar');
    if(el) el.classList.add('hidden');
  }
  renderLogs();
  renderPrestigios();
  updateEndgameUnlocks();
}
// FunÃ§Ãµes utilitÃ¡rias para desenvolvedores/testers
function initDevTools(){
  try{
    const params = new URLSearchParams(location.search);
    const dev = params.get('dev') === '1' || localStorage.getItem('dev_mode') === '1';
    if(dev){
      const p = document.getElementById('devPanel'); if(p) p.style.display = 'block';
      localStorage.setItem('dev_mode','1');
      console.info('Dev mode ativado');
    }
  }catch(e){/* ignore */}
}
function toggleDevTools(){ const p = document.getElementById('devPanel'); if(!p) return; p.style.display = (p.style.display==='block') ? 'none' : 'block'; localStorage.setItem('dev_mode', p.style.display==='block' ? '1' : '0'); }
document.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='d'){ toggleDevTools(); } });

function devAddMoney(val){
  const v = typeof val === 'number' ? val : Number(document.getElementById('devMoneyInput').value)||0;
  dinheiro += v;
  salvar(true);
  atualizar();
  console.info('Dev: adicionou dinheiro', v);
}
function devAddPrestige(){ const v = Number(document.getElementById('devPrestigeInput').value)||0; prestigios += v; renderPrestigios(); salvar(true); atualizar(); console.info('Dev: adicionou prestigio', v); }
function devSetPrestige(v){ prestigios = Number(v)||0; renderPrestigios(); salvar(true); atualizar(); console.info('Dev: set prestige',prestigios);} 
function devSetLevel(){ const v = Number(document.getElementById('devLevelInput').value)||1; nivel = v; atualizar(); salvar(true); console.info('Dev: set level', v); }
function devGiveVehicle(){ const name = document.getElementById('devVehicleName').value || 'DevCar'; const price = Number(document.getElementById('devVehiclePrice').value)||0; veiculosComprados.push({nome:name,preco:price}); salvar(true); atualizar(); console.info('Dev: deu veiculo', name); }
function devGiveHouse(){ const name = document.getElementById('devHouseName').value || 'DevHouse'; const price = Number(document.getElementById('devHousePrice').value)||0; casasCompradas.push({nome:name,preco:price}); rendaPassiva += Math.floor(price/100); salvar(true); atualizar(); console.info('Dev: deu casa', name); }
function devGiveVehiclesPreset(){ devGiveVehicleHelper('DevCar A',1000); devGiveVehicleHelper('DevCar B',1500); devGiveVehicleHelper('DevCar C',2000); salvar(true); atualizar(); }
function devGiveVehicleHelper(n,p){ veiculosComprados.push({nome:n,preco:p}); }
function devGiveHousesPreset(){ devGiveHouseHelper('DevHouse A',10000); devGiveHouseHelper('DevHouse B',20000); devGiveHouseHelper('DevHouse C',50000); salvar(true); atualizar(); }
function devGiveHouseHelper(n,p){ casasCompradas.push({nome:n,preco:p}); rendaPassiva += Math.floor(p/100); }
function devReset(){ if(!confirm('Resetar variÃ¡veis de desenvolvimento?')) return; dinheiro=0; renda=1; nivel=1; rendaPassiva=0; prestigios=0; veiculosComprados=[]; casasCompradas=[]; salvar(true); atualizar(); console.info('Dev: reset completo'); }
// Inicializar devtools se parÃ¢metro presente
initDevTools();

// Carregar save do jogador antes de inicializar logs que podem gravar estado
carregar();
// inicializa logs (chama uma vez ao carregar)
initLogs();

// carregar listas locais e iniciar auto-update de rankings
loadChosenNames(); loadLeaderboards();
// semear logs de atualizaÃ§Ã£o (apenas uma vez por versÃ£o)
seedUpdateLogs();
// disparar uma atualizaÃ§Ã£o imediata (e depois a cada 2 minutos)
autoUpdateRankings();

startMarket();
atualizar();

// Periodic autosave para reduzir risco de perda ao recarregar
setInterval(()=> salvar(), 5000); // salva a cada 5s (salvar tem throttle interno)


window.addEventListener('beforeunload', () => {
  salvar();
});



window.addEventListener('beforeunload', () => {
  salvar(true);
});



// ForÃ§a save ao descarregar a pÃ¡gina (recarregar/fechar)
window.addEventListener('beforeunload', ()=> salvar(true));
</script>
</body>
</html>









