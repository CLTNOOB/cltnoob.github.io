<!DOCTYPE html>
<html lang="pt-BR">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H81BYYMM81"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-H81BYYMM81');
</script>
<meta charset="UTF-8">
<title>Simula√ß√£o de Neg√≥cios 2.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
:root {
    --primary: #00c6ff;
    --secondary: #0072ff;
    --bg-dark: #121212;
    --bg-card: #1e1e1e;
    --text-main: #ffffff;
    --text-muted: #b0b3b8;
    --success: #00e676;
    --danger: #ff5252;
    --nav-height: 60px;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg-dark);
    color: var(--text-main);
    padding-bottom: calc(var(--nav-height) + 20px);
    overflow-x: hidden;
}

/* --- Header --- */
header {
    background: linear-gradient(135deg, #1c1c1c, #2a2a2a);
    padding: 15px 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    position: sticky; top: 0; z-index: 100;
    display: flex; justify-content: space-between; align-items: center;
}
h1 { margin: 0; font-size: 1.2rem; background: -webkit-linear-gradient(var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.save-status { font-size: 0.75rem; color: var(--text-muted); }

/* --- Main Layout --- */
main { max-width: 800px; margin: 0 auto; padding: 15px; }

/* --- Cards & Sections --- */
.view-section { display: none; animation: fadeIn 0.3s ease; }
.view-section.active { display: block; }

.card {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.05);
}
.card h2 { margin-top: 0; font-size: 1.1rem; color: var(--primary); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }

/* --- Announcement Ticker --- */
.announcement {
    background: linear-gradient(90deg, #2c3e50, #000);
    border-left: 4px solid var(--primary);
    transition: background-color 0.3s;
}
#newsTicker { font-style: italic; color: #ddd; font-size: 0.9rem; }

/* --- Dashboard Stats --- */
.stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
.stat-box { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center; }
.stat-label { font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 4px; }
.stat-value { font-size: 1.1rem; font-weight: bold; color: #fff; }
.money-highlight { color: var(--success); font-size: 1.3rem; }

/* --- Buttons --- */
button {
    background: linear-gradient(90deg, var(--secondary), var(--primary));
    color: #fff;
    border: none; padding: 12px;
    border-radius: 8px; cursor: pointer;
    font-weight: 600; width: 100%;
    transition: transform 0.1s, opacity 0.2s;
    margin-top: 5px;
}
button:active { transform: scale(0.98); }
button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
button.secondary-btn { background: rgba(255,255,255,0.1); color: var(--text-muted); }
button.danger-btn { background: var(--danger); }
button.buy-btn { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; text-align: left; }

/* --- Navigation Bar --- */
.bottom-nav {
    position: fixed; bottom: 0; left: 0; width: 100%;
    height: var(--nav-height);
    background: #1a1a1a;
    display: flex; justify-content: space-around; align-items: center;
    border-top: 1px solid rgba(255,255,255,0.1);
    z-index: 1000;
    backdrop-filter: blur(10px);
}
.nav-item {
    color: var(--text-muted);
    text-align: center;
    font-size: 0.7rem;
    cursor: pointer;
    flex: 1;
    padding: 8px 0;
    position: relative;
    transition: color 0.3s;
}
.nav-item.active { color: var(--primary); }
.nav-icon { font-size: 1.4rem; display: block; margin-bottom: 2px; }
.notification-dot {
    position: absolute; top: 5px; right: 25%;
    width: 8px; height: 8px;
    background: var(--danger);
    border-radius: 50%;
    display: none;
}

/* --- Specific Modules --- */
/* Trade */
#graph-container { position: relative; height: 220px; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
.trade-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
.leverage-selector { display: flex; gap: 5px; margin: 10px 0; justify-content: center; }
.lev-btn { background: #333; padding: 5px 10px; font-size: 0.8rem; }
.lev-btn.selected { background: var(--primary); color: #000; }

/* Ranking */
.ranking-list { list-style: none; padding: 0; margin: 0; }
.ranking-item { 
    display: flex; justify-content: space-between; 
    padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); 
    align-items: center;
}
.ranking-item:nth-child(1) .rank-pos { color: #ffd700; font-size: 1.2rem; }
.ranking-item:nth-child(2) .rank-pos { color: #c0c0c0; font-size: 1.1rem; }
.ranking-item:nth-child(3) .rank-pos { color: #cd7f32; font-size: 1.1rem; }
.ranking-item.is-player { background: rgba(0, 198, 255, 0.1); border-left: 3px solid var(--primary); }

/* Tabs inside sections */
.sub-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px; }
.sub-tab-btn { background: none; border: none; color: #777; padding: 8px 15px; width: auto; font-size: 0.9rem; border-radius: 20px; }
.sub-tab-btn.active { background: rgba(255,255,255,0.1); color: #fff; }

/* Tutorial & Overlay */
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; justify-content: center; align-items: center; }
.hidden { display: none !important; }
.modal { background: var(--bg-card); width: 90%; max-width: 500px; padding: 20px; border-radius: 12px; position: relative; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<header>
    <div>
        <h1>üíº Business Sim 2.1</h1>
        <div id="saveStatus" class="save-status">Carregando...</div>
    </div>
    <div style="text-align:right">
        <span class="stat-label">N√≠vel</span>
        <strong id="headerLevel">1</strong>
    </div>
</header>

<main>

    <!-- SECTION: HOME (Vis√£o Geral) -->
    <div id="view-home" class="view-section active">
        <div class="card">
            <div class="stats-grid">
                <div class="stat-box" style="grid-column: span 2;">
                    <span class="stat-label">Dinheiro Total</span>
                    <div class="stat-value money-highlight" id="moneyDisplay">0</div>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Renda / Clique</span>
                    <div class="stat-value" id="incomeDisplay">1</div>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Renda Passiva</span>
                    <div class="stat-value" id="passiveDisplay">0</div>
                </div>
            </div>
            <button onclick="ganharDinheiro()" style="height: 60px; font-size: 1.2rem; margin-top: 15px;">üí∏ TRABALHAR</button>
            <button id="upgradeBtn" onclick="upgrade()" class="secondary-btn">
                Melhorar Habilidades (Custo: <span id="upgradeCost">100</span>)
            </button>
        </div>
        
        <div class="card announcement" id="homeNews">
            <h2>üì¢ √öltimas Not√≠cias</h2>
            <p id="newsTicker">Bem-vindo ao mercado! Os neg√≥cios est√£o aquecidos.</p>
        </div>
    </div>

    <!-- SECTION: MARKET (Finan√ßas & Trade) -->
    <div id="view-market" class="view-section">
        <div class="sub-tabs">
            <button class="sub-tab-btn active" onclick="switchSubTab('market', 'trade')">üìà Trade</button>
            <button class="sub-tab-btn" onclick="switchSubTab('market', 'invest')">üè¶ Investimentos</button>
            <button class="sub-tab-btn" onclick="switchSubTab('market', 'loan')">üí∏ Empr√©stimo</button>
        </div>

        <!-- Sub: Trade -->
        <div id="sub-market-trade">
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>Pre√ßo: <strong id="marketPrice">100.00</strong></span>
                    <span id="marketTrend">Neutro</span>
                </div>
                <div id="graph-container">
                    <canvas id="chart"></canvas>
                </div>
                
                <div class="leverage-selector">
                    <span style="font-size:0.8rem; align-self:center; color:#ccc">Alavancagem:</span>
                    <button class="lev-btn selected" onclick="setLeverage(1)">x1</button>
                    <button class="lev-btn" onclick="setLeverage(5)">x5</button>
                    <button class="lev-btn" onclick="setLeverage(10)">x10</button>
                </div>

                <input type="number" id="tradeAmount" placeholder="Valor para investir" style="width:100%; padding:10px; background:#333; border:none; color:#fff; border-radius:6px; margin-bottom:5px;">
                
                <div id="activeTradeInfo" class="hidden" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; margin-bottom:10px; text-align:center;">
                    Resultado: <strong id="tradePnl">0</strong>
                    <button onclick="closeTrade()" style="background:var(--danger); margin-top:5px;">Fechar Posi√ß√£o</button>
                </div>

                <div class="trade-controls" id="openTradeControls">
                    <button onclick="openTrade('up')" style="background:#00e676; color:#003300;">‚¨Ü COMPRAR (Long)</button>
                    <button onclick="openTrade('down')" style="background:#ff5252; color:#330000;">‚¨á VENDER (Short)</button>
                </div>
            </div>
        </div>

        <!-- Sub: Investments -->
        <div id="sub-market-invest" class="hidden">
            <div class="card" id="investList">
                <!-- Preenchido via JS -->
            </div>
        </div>

        <!-- Sub: Loan -->
        <div id="sub-market-loan" class="hidden">
             <div class="card">
                <h2>Gerente do Banco</h2>
                <div class="stat-box" style="margin-bottom:15px;">
                    <span class="stat-label">D√≠vida Atual</span>
                    <div class="stat-value" id="loanDebt">0</div>
                    <small>Juros: 2% a cada 30s</small>
                </div>
                <input type="number" id="loanInput" placeholder="Valor" style="width:100%; padding:10px; border-radius:6px; border:none;">
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button onclick="takeLoan()" style="flex:1;">Pegar Empr√©stimo</button>
                    <button onclick="payLoan()" class="secondary-btn" style="flex:1;">Pagar D√≠vida</button>
                </div>
             </div>
        </div>
    </div>

    <!-- SECTION: ASSETS (Patrim√¥nio) -->
    <div id="view-assets" class="view-section">
        <div class="sub-tabs">
            <button class="sub-tab-btn active" onclick="switchSubTab('assets', 'houses')">üè† Im√≥veis</button>
            <button class="sub-tab-btn" onclick="switchSubTab('assets', 'vehicles')">üöó Ve√≠culos</button>
            <button class="sub-tab-btn" onclick="switchSubTab('assets', 'gallery')">üñºÔ∏è Galeria</button>
        </div>
        
        <div id="sub-assets-houses">
            <div id="houseList"></div>
        </div>
        <div id="sub-assets-vehicles" class="hidden">
            <div id="vehicleList"></div>
        </div>
        <div id="sub-assets-gallery" class="hidden">
            <div class="card">
                <p style="color:#ccc; text-align:center;">Seus itens raros e conquistas aparecem aqui.</p>
                <div id="galleryGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(80px, 1fr)); gap:10px; margin-top:10px;"></div>
            </div>
        </div>
    </div>

    <!-- SECTION: RANKING -->
    <div id="view-ranking" class="view-section">
        <div class="card">
            <h2>üèÜ Leaderboard Global (IA Ativa)</h2>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button onclick="renderRanking('money')" class="secondary-btn">Mais Ricos</button>
                <button onclick="renderRanking('level')" class="secondary-btn">Maior N√≠vel</button>
            </div>
            <div style="background: rgba(0,0,0,0.2); border-radius:8px; padding:10px;">
                <div style="display:flex; justify-content:space-between; padding:5px; color:#777; font-size:0.8rem;">
                    <span># JOGADOR</span>
                    <span>VALOR</span>
                </div>
                <ul id="rankingList" class="ranking-list">
                    <!-- JS -->
                </ul>
            </div>
            <p style="font-size:0.8rem; color:#555; text-align:center; margin-top:10px;">IAs jogam em tempo real. Continue evoluindo!</p>
        </div>
    </div>

    <!-- SECTION: MENU (Settings & Prestige) -->
    <div id="view-menu" class="view-section">
        <div class="card">
            <h2>‚öôÔ∏è Configura√ß√µes</h2>
            <div>Nome: <strong id="playerNameDisplay">-</strong></div>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="text" id="newNameInput" placeholder="Novo nome" style="padding:8px; border-radius:6px; border:none; width:70%;">
                <button class="secondary-btn" style="width:30%; margin-top:0;" onclick="changeName()">Salvar</button>
            </div>
            
            <hr style="border-color:rgba(255,255,255,0.1); margin:15px 0;">
            
            <button onclick="restartTutorial()" class="secondary-btn">üéì Rever Tutorial</button>
            <button onclick="forceSave()">üíæ Salvar Manualmente</button>
            <button onclick="exportSave()" class="secondary-btn">Exportar Save</button>
            <button onclick="document.getElementById('importFile').click()" class="secondary-btn">Importar Save</button>
            <input type="file" id="importFile" class="hidden" onchange="importSave(this)">
            <button onclick="resetGame()" class="danger-btn">üóëÔ∏è Resetar Tudo</button>
        </div>

        <div class="card">
            <h2>üèÖ Prest√≠gio</h2>
            <div class="stats-grid">
                <div class="stat-box"><span class="stat-label">Medalhas</span><strong id="prestigeMedals">0</strong></div>
                <div class="stat-box"><span class="stat-label">B√¥nus Global</span><strong id="prestigeBonus">0%</strong></div>
            </div>
            <p style="font-size:0.9rem; color:#ccc; margin-top:10px;">Reseta seu dinheiro e constru√ß√µes, mas mant√©m medalhas e b√¥nus. Requer: 1 Milh√£o.</p>
            <button id="btnPrestige" onclick="doPrestige()" disabled>Prestigiar</button>
        </div>

        <div class="card" id="updatesCard">
            <h2>üìú Atualiza√ß√µes</h2>
            <div id="changelogList" style="max-height:150px; overflow-y:auto; font-size:0.9rem;"></div>
            <button onclick="markUpdatesRead()" class="secondary-btn">Marcar como lidas</button>
        </div>
    </div>

</main>

<!-- BOTTOM NAVIGATION -->
<nav class="bottom-nav">
    <div class="nav-item active" onclick="navTo('home')">
        <span class="nav-icon">üè†</span>In√≠cio
    </div>
    <div class="nav-item" onclick="navTo('market')">
        <span class="nav-icon">üìà</span>Mercado
    </div>
    <div class="nav-item" onclick="navTo('assets')">
        <span class="nav-icon">üè¢</span>Ativos
    </div>
    <div class="nav-item" onclick="navTo('ranking')">
        <span class="nav-icon">üèÜ</span>Ranking
    </div>
    <div class="nav-item" onclick="navTo('menu')">
        <span class="nav-icon">‚ò∞</span>Menu
        <div id="menuNotif" class="notification-dot"></div>
    </div>
</nav>

<!-- Tutorial Overlay -->
<div id="tutorialOverlay" class="overlay hidden">
    <div class="modal">
        <h2 id="tutTitle">Bem-vindo!</h2>
        <p id="tutText">Vamos aprender a ganhar dinheiro?</p>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button class="secondary-btn" onclick="skipTutorial()">Pular</button>
            <button onclick="nextTutorial()">Pr√≥ximo ‚ñ∂</button>
        </div>
    </div>
</div>

<script>
/* =========================================
   CORE VARIABLES & STATE
   ========================================= */
const STATE = {
    money: 0,
    income: 1,
    level: 1,
    passive: 0,
    upgradeCost: 100,
    prestige: 0,
    houses: [],
    vehicles: [],
    gallery: [],
    investments: [], 
    loan: { debt: 0, lastUpdate: Date.now() },
    name: "Player",
    startTime: Date.now(),
    lastSave: Date.now(),
    updatesRead: 0,
    tutorialStep: 0
};

const GAME_DATA = {
    investments: [
        { name: "Fundo Conservador", cost: 5000, return: 30, desc: "+30/ciclo" },
        { name: "Start-up Tech", cost: 15000, return: 100, desc: "+100/ciclo" },
        { name: "Minera√ß√£o Bitcoin", cost: 45000, return: 350, desc: "+350/ciclo" },
        { name: "Conglomerado", cost: 150000, return: 1200, desc: "+1200/ciclo" }
    ],
    houses: [
        { name: "Kitnet", cost: 10000, return: 50 },
        { name: "Apartamento", cost: 50000, return: 300 },
        { name: "Mans√£o", cost: 500000, return: 3500 },
        { name: "Ilha Privada", cost: 5000000, return: 40000 }
    ],
    vehicles: [
        { name: "Carro Popular", cost: 20000 },
        { name: "SUV de Luxo", cost: 80000 },
        { name: "Superesportivo", cost: 250000 },
        { name: "Jatinho", cost: 1500000 }
    ],
    updates: [
        "2.1: Tutorial reativ√°vel e inteligente.",
        "2.1: IA de Ranking melhorada e competitiva.",
        "2.1: Not√≠cias em tempo real baseadas na IA.",
        "2.0: Interface totalmente nova!",
    ]
};

// Ranking Simulado & IA
let fakePlayers = [];

// Trade System
let market = { price: 100, history: [], trend: 0, volatility: 0.5 };
let activeTrade = null; 
let leverage = 1;

// Timers
let passiveTimer;
let marketTimer;
let saveTimer;

/* =========================================
   INITIALIZATION
   ========================================= */
window.onload = function() {
    loadGame();
    initUI();
    initRanking();
    startLoops();
    checkTutorial();
    renderAll();
};

function initUI() {
    // Generate Investment Buttons
    const invList = document.getElementById('investList');
    invList.innerHTML = GAME_DATA.investments.map((inv, i) => `
        <button class="buy-btn secondary-btn" onclick="buyInvestment(${i})">
            <div>
                <div style="font-weight:bold; color:var(--primary)">${inv.name}</div>
                <div style="font-size:0.8rem; color:#ccc">${inv.desc}</div>
            </div>
            <div style="text-align:right">
                <div>$${inv.cost.toLocaleString()}</div>
                <small>Comprar</small>
            </div>
        </button>
    `).join('');

    // Generate House List
    const houseList = document.getElementById('houseList');
    houseList.innerHTML = GAME_DATA.houses.map((h, i) => `
        <button class="buy-btn secondary-btn" onclick="buyHouse(${i})">
            <div>üè† ${h.name}</div>
            <div>$${h.cost.toLocaleString()} <br><small>+${h.return}/s</small></div>
        </button>
    `).join('');

    // Generate Vehicle List
    const vehList = document.getElementById('vehicleList');
    vehList.innerHTML = GAME_DATA.vehicles.map((v, i) => `
        <button class="buy-btn secondary-btn" onclick="buyVehicle(${i})">
            <div>üöó ${v.name}</div>
            <div>$${v.cost.toLocaleString()}</div>
        </button>
    `).join('');

    // Changelog
    const logList = document.getElementById('changelogList');
    logList.innerHTML = GAME_DATA.updates.map(u => `<div style="padding:5px; border-bottom:1px solid #333">${u}</div>`).join('');
    
    // Notification
    if(GAME_DATA.updates.length > STATE.updatesRead) {
        document.getElementById('menuNotif').style.display = 'block';
    }
}

/* =========================================
   NAVIGATION SYSTEM
   ========================================= */
function navTo(viewId) {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.getElementById(`view-${viewId}`).classList.add('active');
    
    if(viewId === 'ranking') updateRankingVisuals();
    if(viewId === 'market') resizeChart();
}

function switchSubTab(parent, sub) {
    document.querySelectorAll(`#view-${parent} .sub-tab-btn`).forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    
    const container = document.getElementById(`view-${parent}`);
    container.querySelectorAll('[id^="sub-"]').forEach(d => d.classList.add('hidden'));
    document.getElementById(`sub-${parent}-${sub}`).classList.remove('hidden');
}

/* =========================================
   GAMEPLAY LOGIC
   ========================================= */
function ganharDinheiro() {
    const prestigeMul = 1 + (STATE.prestige * 0.05); 
    const amount = Math.floor(STATE.income * prestigeMul);
    STATE.money += amount;
    updateStats();
}

function upgrade() {
    if(STATE.money >= STATE.upgradeCost) {
        STATE.money -= STATE.upgradeCost;
        STATE.income += Math.floor(1 + (STATE.level * 0.5));
        STATE.level++;
        STATE.upgradeCost = Math.floor(STATE.upgradeCost * 1.5);
        renderAll();
    }
}

function buyInvestment(idx) {
    const item = GAME_DATA.investments[idx];
    if(STATE.money >= item.cost) {
        STATE.money -= item.cost;
        STATE.passive += item.return;
        STATE.investments.push(idx);
        alert(`Voc√™ comprou: ${item.name}!`);
        renderAll();
    } else {
        alert("Dinheiro insuficiente!");
    }
}

function buyHouse(idx) {
    const item = GAME_DATA.houses[idx];
    if(STATE.money >= item.cost) {
        STATE.money -= item.cost;
        STATE.passive += item.return;
        STATE.houses.push(idx);
        alert(`Im√≥vel adquirido: ${item.name}`);
        renderAll();
    } else alert("Falta verba!");
}

function buyVehicle(idx) {
    const item = GAME_DATA.vehicles[idx];
    if(STATE.money >= item.cost) {
        STATE.money -= item.cost;
        STATE.vehicles.push(idx);
        addToGallery(`Chave do ${item.name}`);
        alert("Ve√≠culo na garagem!");
        renderAll();
    } else alert("Dinheiro insuficiente!");
}

function addToGallery(itemName) {
    if(!STATE.gallery.includes(itemName)) {
        STATE.gallery.push(itemName);
        renderGallery();
    }
}

function renderGallery() {
    const grid = document.getElementById('galleryGrid');
    grid.innerHTML = STATE.gallery.map(i => `<div style="background:#333; padding:5px; border-radius:4px; font-size:0.7rem; text-align:center;">${i}</div>`).join('');
}

/* =========================================
   TRADE SYSTEM (MARKET)
   ========================================= */
function initMarket() {
    for(let i=0; i<50; i++) tickMarket(true);
}

function tickMarket(silent = false) {
    if(Math.random() < 0.05) market.trend = (Math.random() - 0.5); 
    
    let change = (Math.random() - 0.5 + market.trend * 0.2) * market.volatility;
    market.price = Math.max(10, market.price + change);
    market.history.push(market.price);
    if(market.history.length > 50) market.history.shift();

    if(!silent) {
        drawChart();
        document.getElementById('marketPrice').innerText = market.price.toFixed(2);
        document.getElementById('marketTrend').innerText = change > 0 ? "Alta ‚ñ≤" : "Baixa ‚ñº";
        document.getElementById('marketTrend').style.color = change > 0 ? varCSS('--success') : varCSS('--danger');
        updateActiveTrade();
    }
}

function drawChart() {
    const ctx = document.getElementById('chart').getContext('2d');
    const container = document.getElementById('graph-container');
    const w = ctx.canvas.width = container.offsetWidth;
    const h = ctx.canvas.height = 220;
    
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);
    
    const min = Math.min(...market.history) * 0.95;
    const max = Math.max(...market.history) * 1.05;
    const range = max - min;
    
    ctx.beginPath();
    ctx.strokeStyle = market.history[market.history.length-1] > market.history[market.history.length-2] ? '#00e676' : '#ff5252';
    ctx.lineWidth = 2;
    
    market.history.forEach((p, i) => {
        const x = (i / (market.history.length-1)) * w;
        const y = h - ((p - min) / range) * h;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

function setLeverage(val) {
    leverage = val;
    document.querySelectorAll('.lev-btn').forEach(b => b.classList.remove('selected'));
    event.target.classList.add('selected');
}

function openTrade(direction) {
    if(activeTrade) return alert("Feche a posi√ß√£o atual antes de abrir outra.");
    const val = parseFloat(document.getElementById('tradeAmount').value);
    if(!val || val <= 0 || val > STATE.money) return alert("Valor inv√°lido.");
    
    STATE.money -= val;
    activeTrade = { type: direction, entry: market.price, amount: val, leverage: leverage };
    
    document.getElementById('activeTradeInfo').classList.remove('hidden');
    document.getElementById('openTradeControls').classList.add('hidden');
    renderAll();
}

function updateActiveTrade() {
    if(!activeTrade) return;
    const current = market.price;
    const diffPct = (current - activeTrade.entry) / activeTrade.entry;
    const rawPnlPct = activeTrade.type === 'up' ? diffPct : -diffPct;
    const leveragedPnl = rawPnlPct * activeTrade.leverage;
    
    const profit = Math.floor(activeTrade.amount * leveragedPnl);
    const el = document.getElementById('tradePnl');
    el.innerText = (profit > 0 ? "+" : "") + profit;
    el.style.color = profit >= 0 ? varCSS('--success') : varCSS('--danger');
    
    if(leveragedPnl <= -1) {
        closeTrade(true);
    }
}

function closeTrade(forced = false) {
    if(!activeTrade) return;
    const current = market.price;
    const diffPct = (current - activeTrade.entry) / activeTrade.entry;
    const rawPnlPct = activeTrade.type === 'up' ? diffPct : -diffPct;
    const profit = Math.floor(activeTrade.amount * rawPnlPct * activeTrade.leverage);
    
    const totalReturn = activeTrade.amount + profit;
    if(totalReturn > 0) STATE.money += totalReturn;
    
    if(forced) alert("Posi√ß√£o LIQUIDADA! Voc√™ perdeu o investimento.");
    else alert(`Trade fechado. Resultado: ${profit}`);
    
    activeTrade = null;
    document.getElementById('activeTradeInfo').classList.add('hidden');
    document.getElementById('openTradeControls').classList.remove('hidden');
    renderAll();
}

/* =========================================
   LOAN SYSTEM
   ========================================= */
function takeLoan() {
    const val = parseFloat(document.getElementById('loanInput').value);
    if(!val || val <= 0) return;
    const limit = Math.max(1000, STATE.money * 2); 
    if(STATE.loan.debt + val > limit) return alert(`Banco negou. Limite de d√≠vida: ${limit}`);
    
    STATE.money += val;
    STATE.loan.debt += val;
    renderAll();
}

function payLoan() {
    const val = parseFloat(document.getElementById('loanInput').value);
    if(!val || val <= 0) return;
    const toPay = Math.min(val, STATE.loan.debt);
    if(STATE.money >= toPay) {
        STATE.money -= toPay;
        STATE.loan.debt -= toPay;
        renderAll();
    } else alert("Dinheiro insuficiente.");
}

/* =========================================
   SMART AI & RANKING (COMPETITIVE)
   ========================================= */
function initRanking() {
    const saved = localStorage.getItem('fakePlayers');
    if(saved) {
        fakePlayers = JSON.parse(saved);
    } else {
        const personas = [
            { name: "Elon M.", strategy: "risk", income: 20 },
            { name: "Jeff B.", strategy: "steady", income: 15 },
            { name: "Warren B.", strategy: "saver", income: 10 },
            { name: "Satoshi N.", strategy: "risk", income: 25 },
            { name: "Mark Z.", strategy: "steady", income: 18 }
        ];
        fakePlayers = personas.map(p => ({
            name: p.name,
            money: Math.floor(Math.random() * 2000),
            level: Math.floor(Math.random() * 5) + 1,
            income: p.income,
            strategy: p.strategy
        }));
    }
}

function updateRankingSim() {
    // Calcula velocidade de crescimento do jogador para a IA acompanhar
    const playerVelocity = (STATE.income * 2) + STATE.passive + 10;
    
    fakePlayers.forEach(p => {
        // Renda base da IA
        let gain = p.income + (Math.random() * playerVelocity * 0.5);
        
        // Simula√ß√£o de a√ß√µes baseada em estrat√©gia
        const actionRoll = Math.random();
        
        if(p.strategy === "risk" && actionRoll < 0.2) {
            // IA faz "trade" ou investimento arriscado
            const result = (Math.random() - 0.4); // Vi√©s positivo leve
            gain += gain * result * 5; 
            if(result > 0.3) triggerAiNews(p.name, "acertou um trade alavancado!");
        } 
        else if(p.strategy === "steady" && actionRoll < 0.1) {
            // IA compra im√≥vel
            p.income += 10; 
            gain -= 500; // Gasta dinheiro
            triggerAiNews(p.name, "adquiriu novos im√≥veis.");
        }
        else if(p.strategy === "saver") {
            // Apenas acumula juros compostos
            gain *= 1.05;
        }

        p.money += Math.floor(gain);
        if(p.money < 0) p.money = 100; // Evita fal√™ncia total

        // Evolu√ß√£o de n√≠vel
        if(p.money > p.level * 2000 && Math.random() < 0.1) {
            p.level++;
            triggerAiNews(p.name, `subiu para o N√≠vel ${p.level}!`);
        }
    });
    
    localStorage.setItem('fakePlayers', JSON.stringify(fakePlayers));
    if(document.getElementById('view-ranking').classList.contains('active')) {
        renderRanking('money');
    }
}

function triggerAiNews(name, action) {
    // S√≥ mostra not√≠cia se for sorteado para evitar spam
    if(Math.random() < 0.15) {
        addNews(`${name} ${action}`);
    }
}

function renderRanking(criteria) {
    const list = document.getElementById('rankingList');
    let all = [...fakePlayers, { name: STATE.name + " (Voc√™)", money: STATE.money, level: STATE.level, isPlayer: true }];
    all.sort((a, b) => b[criteria] - a[criteria]);
    
    list.innerHTML = all.map((p, i) => `
        <li class="ranking-item ${p.isPlayer ? 'is-player' : ''}">
            <div style="display:flex; gap:10px; align-items:center;">
                <span class="rank-pos">#${i+1}</span>
                <span>${p.name}</span>
            </div>
            <strong>${criteria === 'money' ? '$' + formatNumber(p.money) : 'Lvl ' + p.level}</strong>
        </li>
    `).join('');
}

function updateRankingVisuals() { renderRanking('money'); }

/* =========================================
   CORE LOOPS & UTILS
   ========================================= */
function startLoops() {
    passiveTimer = setInterval(() => {
        if(STATE.passive > 0) {
            const prestigeMul = 1 + (STATE.prestige * 0.05);
            STATE.money += Math.floor(STATE.passive * prestigeMul);
            updateStats();
        }
        if(STATE.loan.debt > 0) {
            const now = Date.now();
            if(now - STATE.loan.lastUpdate > 30000) {
                STATE.loan.debt = Math.floor(STATE.loan.debt * 1.02);
                STATE.loan.lastUpdate = now;
                addNews("O banco cobrou juros do seu empr√©stimo.");
            }
        }
    }, 1000);

    initMarket();
    marketTimer = setInterval(() => tickMarket(), 500);

    // Save & Ranking Update (5s)
    saveTimer = setInterval(() => {
        updateRankingSim();
        saveGame();
    }, 5000);
}

function updateStats() {
    document.getElementById('moneyDisplay').innerText = formatNumber(STATE.money);
    document.getElementById('incomeDisplay').innerText = formatNumber(STATE.income);
    document.getElementById('passiveDisplay').innerText = formatNumber(STATE.passive);
    document.getElementById('headerLevel').innerText = STATE.level;
    document.getElementById('upgradeCost').innerText = formatNumber(STATE.upgradeCost);
    document.getElementById('loanDebt').innerText = formatNumber(STATE.loan.debt);
    
    const req = 1000000 * (STATE.prestige + 1);
    const btnP = document.getElementById('btnPrestige');
    btnP.innerText = `Prestigiar (Req: ${formatNumber(req)})`;
    btnP.disabled = STATE.money < req;
}

function renderAll() {
    updateStats();
    renderGallery();
}

function formatNumber(num) {
    if(num >= 1000000) return (num/1000000).toFixed(2) + 'M';
    if(num >= 1000) return (num/1000).toFixed(1) + 'k';
    return num.toLocaleString();
}

function varCSS(name) {
    return getComputedStyle(document.body).getPropertyValue(name).trim();
}

function addNews(text) {
    const news = document.getElementById('homeNews');
    const ticker = document.getElementById('newsTicker');
    
    // Efeito visual de atualiza√ß√£o
    news.style.backgroundColor = "#2a3b4c";
    ticker.style.opacity = 0;
    
    setTimeout(() => {
        ticker.innerText = text;
        ticker.style.opacity = 1;
        news.style.backgroundColor = ""; 
    }, 300);
}

/* =========================================
   SAVE / LOAD / SETTINGS
   ========================================= */
function saveGame() {
    STATE.lastSave = Date.now();
    localStorage.setItem('bizSimSave_v2', JSON.stringify(STATE));
    document.getElementById('saveStatus').innerText = 'Salvo: ' + new Date().toLocaleTimeString();
}

function loadGame() {
    const data = localStorage.getItem('bizSimSave_v2');
    if(data) {
        const loaded = JSON.parse(data);
        Object.assign(STATE, loaded);
        document.getElementById('playerNameDisplay').innerText = STATE.name;
        document.getElementById('prestigeMedals').innerText = STATE.prestige;
        document.getElementById('prestigeBonus').innerText = (STATE.prestige * 5) + "%";
    }
}

function forceSave() { saveGame(); alert("Jogo Salvo!"); }

function resetGame() {
    if(confirm("Tem certeza? Isso apaga TUDO.")) {
        localStorage.removeItem('bizSimSave_v2');
        localStorage.removeItem('tutCompleted_v2');
        location.reload();
    }
}

function changeName() {
    const input = document.getElementById('newNameInput');
    const newName = input.value.trim();
    if(newName.length > 0 && newName.length <= 15) {
        STATE.name = newName;
        document.getElementById('playerNameDisplay').innerText = newName;
        saveGame();
        input.value = "";
        alert("Nome alterado com sucesso!");
    } else {
        alert("Nome inv√°lido (use entre 1 e 15 caracteres).");
    }
}

function markUpdatesRead() {
    STATE.updatesRead = GAME_DATA.updates.length;
    document.getElementById('menuNotif').style.display = 'none';
    saveGame();
    alert("Todas lidas!");
}

function doPrestige() {
    const req = 1000000 * (STATE.prestige + 1);
    if(STATE.money < req) return;
    if(!confirm("Ao prestigiar, voc√™ perde dinheiro e ativos, mas ganha medalhas que aumentam seus lucros permanentemente. Continuar?")) return;
    
    STATE.prestige++;
    STATE.money = 0;
    STATE.income = 1;
    STATE.level = 1;
    STATE.passive = 0;
    STATE.upgradeCost = 100;
    STATE.houses = [];
    STATE.vehicles = [];
    STATE.investments = [];
    STATE.loan.debt = 0;
    
    saveGame();
    location.reload();
}

function exportSave() {
    const data = btoa(JSON.stringify(STATE));
    prompt("Copie este c√≥digo:", data);
}
function importSave(input) {
    const data = prompt("Cole o c√≥digo do save:");
    if(data) {
        try {
            const parsed = JSON.parse(atob(data));
            localStorage.setItem('bizSimSave_v2', JSON.stringify(parsed));
            location.reload();
        } catch(e) { alert("Save inv√°lido"); }
    }
}

/* =========================================
   TUTORIAL
   ========================================= */
const TUTORIAL_STEPS = [
    { target: 'view-home', text: "Bem-vindo! Aqui voc√™ ganha seu dinheiro inicial e melhora suas habilidades." },
    { target: 'view-market', navIdx: 1, text: "No Mercado, voc√™ investe na Bolsa (Trade) e compra Fundos de Investimento." },
    { target: 'view-assets', navIdx: 2, text: "Em Ativos, compre Casas (para renda passiva) e Ve√≠culos (para ostentar na Galeria)." },
    { target: 'view-ranking', navIdx: 3, text: "No Ranking, dispute contra IAs inteligentes para ver quem √© o maior bilion√°rio." }
];

function checkTutorial() {
    if(!localStorage.getItem('tutCompleted_v2')) {
        STATE.tutorialStep = 0;
        showTutorialStep();
    }
}

function restartTutorial() {
    STATE.tutorialStep = 0;
    document.getElementById('tutorialOverlay').classList.remove('hidden');
    navTo('home'); // Volta para o inicio
    showTutorialStep();
}

function showTutorialStep() {
    const step = TUTORIAL_STEPS[STATE.tutorialStep];
    if(!step) {
        document.getElementById('tutorialOverlay').classList.add('hidden');
        localStorage.setItem('tutCompleted_v2', 'true');
        return;
    }
    
    document.getElementById('tutorialOverlay').classList.remove('hidden');
    document.getElementById('tutText').innerText = step.text;
    
    // Highlight Nav Item
    document.querySelectorAll('.nav-item').forEach(el => el.style.color = "");
    if(step.navIdx !== undefined) {
        const navItems = document.querySelectorAll('.nav-item');
        navItems[step.navIdx].style.color = "#00c6ff"; // Highlight
    }
}

function nextTutorial() {
    STATE.tutorialStep++;
    showTutorialStep();
}
function skipTutorial() {
    localStorage.setItem('tutCompleted_v2', 'true');
    document.getElementById('tutorialOverlay').classList.add('hidden');
    document.querySelectorAll('.nav-item').forEach(el => el.style.color = ""); // Reset color
}

function resizeChart() {
    setTimeout(drawChart, 100);
}

</script>
</body>
</html>
