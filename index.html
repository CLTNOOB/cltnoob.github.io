<!DOCTYPE html>
<html lang="pt-BR">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H81BYYMM81"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-H81BYYMM81');
</script>
<meta charset="UTF-8">
<title>Simula√ß√£o de Neg√≥cios 2.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
:root {
    --primary: #00c6ff;
    --secondary: #0072ff;
    --bg-dark: #121212;
    --bg-card: #1e1e1e;
    --text-main: #ffffff;
    --text-muted: #b0b3b8;
    --success: #00e676;
    --danger: #ff5252;
    --nav-height: 60px;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg-dark);
    color: var(--text-main);
    padding-bottom: calc(var(--nav-height) + 20px);
    overflow-x: hidden;
}

/* --- Header --- */
header {
    background: linear-gradient(135deg, #1c1c1c, #2a2a2a);
    padding: 15px 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    position: sticky; top: 0; z-index: 100;
    display: flex; justify-content: space-between; align-items: center;
}
h1 { margin: 0; font-size: 1.2rem; background: -webkit-linear-gradient(var(--primary), var(--secondary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
.save-status { font-size: 0.75rem; color: var(--text-muted); }

/* --- Main Layout --- */
main { max-width: 800px; margin: 0 auto; padding: 15px; }

/* --- Cards & Sections --- */
.view-section { display: none; animation: fadeIn 0.3s ease; }
.view-section.active { display: block; }

.card {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.05);
}
.card h2 { margin-top: 0; font-size: 1.1rem; color: var(--primary); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }

/* --- Announcement Ticker --- */
.announcement {
    background: linear-gradient(90deg, #2c3e50, #000);
    border-left: 4px solid var(--primary);
    transition: background-color 0.3s;
}
#newsTicker { font-style: italic; color: #ddd; font-size: 0.9rem; }

/* --- Dashboard Stats --- */
.stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
.stat-box { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center; }
.stat-label { font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 4px; }
.stat-value { font-size: 1.1rem; font-weight: bold; color: #fff; }
.money-highlight { color: var(--success); font-size: 1.3rem; }

/* --- Buttons --- */
button {
    background: linear-gradient(90deg, var(--secondary), var(--primary));
    color: #fff;
    border: none; padding: 12px;
    border-radius: 8px; cursor: pointer;
    font-weight: 600; width: 100%;
    transition: transform 0.1s, opacity 0.2s;
    margin-top: 5px;
}
button:active { transform: scale(0.98); }
button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
button.secondary-btn { background: rgba(255,255,255,0.1); color: var(--text-muted); }
button.danger-btn { background: var(--danger); }
button.buy-btn { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; text-align: left; }

/* --- Navigation Bar --- */
.bottom-nav {
    position: fixed; bottom: 0; left: 0; width: 100%;
    height: var(--nav-height);
    background: #1a1a1a;
    display: flex; justify-content: space-around; align-items: center;
    border-top: 1px solid rgba(255,255,255,0.1);
    z-index: 1000;
    backdrop-filter: blur(10px);
}
.nav-item {
    color: var(--text-muted);
    text-align: center;
    font-size: 0.7rem;
    cursor: pointer;
    flex: 1;
    padding: 8px 0;
    position: relative;
    transition: color 0.3s;
}
.nav-item.active { color: var(--primary); }
.nav-icon { font-size: 1.4rem; display: block; margin-bottom: 2px; }
.notification-dot {
    position: absolute; top: 5px; right: 25%;
    width: 8px; height: 8px;
    background: var(--danger);
    border-radius: 50%;
    display: none;
}

/* --- Specific Modules --- */
/* Trade */
#graph-container { position: relative; height: 220px; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
.trade-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
.leverage-selector { display: flex; gap: 5px; margin: 10px 0; justify-content: center; }
.lev-btn { background: #333; padding: 5px 10px; font-size: 0.8rem; }
.lev-btn.selected { background: var(--primary); color: #000; }

/* Ranking */
.ranking-list { list-style: none; padding: 0; margin: 0; }
.ranking-item { 
    display: flex; justify-content: space-between; 
    padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); 
    align-items: center;
}
.ranking-item:nth-child(1) .rank-pos { color: #ffd700; font-size: 1.2rem; }
.ranking-item:nth-child(2) .rank-pos { color: #c0c0c0; font-size: 1.1rem; }
.ranking-item:nth-child(3) .rank-pos { color: #cd7f32; font-size: 1.1rem; }
.ranking-item.is-player { background: rgba(0, 198, 255, 0.1); border-left: 3px solid var(--primary); }

/* Tabs inside sections */
.sub-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px; }
.sub-tab-btn { background: none; border: none; color: #777; padding: 8px 15px; width: auto; font-size: 0.9rem; border-radius: 20px; }
.sub-tab-btn.active { background: rgba(255,255,255,0.1); color: #fff; }

/* Tutorial & Overlay */
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; justify-content: center; align-items: center; }
.hidden { display: none !important; }
.modal { background: var(--bg-card); width: 90%; max-width: 500px; padding: 20px; border-radius: 12px; position: relative; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<header>
    <div>
        <h1>üíº Business Sim 2.1</h1>
        <div id="saveStatus" class="save-status">Carregando...</div>
    </div>
    <div style="text-align:right">
        <span class="stat-label">N√≠vel</span>
        <strong id="headerLevel">1</strong>
    </div>
</header>

<main>

    <!-- SECTION: HOME (Vis√£o Geral) -->
    <div id="view-home" class="view-section active">
        <div class="card">
            <div class="stats-grid">
                <div class="stat-box" style="grid-column: span 2;">
                    <span class="stat-label">Dinheiro Total</span>
                    <div class="stat-value money-highlight" id="moneyDisplay">0</div>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Renda / Clique</span>
                    <div class="stat-value" id="incomeDisplay">1</div>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Renda Passiva</span>
                    <div class="stat-value" id="passiveDisplay">0</div>
                </div>
            </div>
            <button onclick="ganharDinheiro()" style="height: 60px; font-size: 1.2rem; margin-top: 15px;">üí∏ TRABALHAR</button>
            <button id="upgradeBtn" onclick="upgrade()" class="secondary-btn">
                Melhorar Habilidades (Custo: <span id="upgradeCost">100</span>)
            </button>
        </div>
        
        <div class="card announcement" id="homeNews">
            <h2>üì¢ √öltimas Not√≠cias</h2>
            <p id="newsTicker">Bem-vindo ao mercado! Os neg√≥cios est√£o aquecidos.</p>
        </div>
    </div>

    <!-- SECTION: MARKET (Finan√ßas & Trade) -->
    <div id="view-market" class="view-section">
        <div class="sub-tabs">
            <button class="sub-tab-btn active" onclick="switchSubTab('market', 'trade')">üìà Trade</button>
            <button class="sub-tab-btn" onclick="switchSubTab('market', 'invest')">üè¶ Investimentos</button>
            <button class="sub-tab-btn" onclick="switchSubTab('market', 'loan')">üí∏ Empr√©stimo</button>
        </div>

        <!-- Sub: Trade -->
        <div id="sub-market-trade">
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>Pre√ßo: <strong id="marketPrice">100.00</strong></span>
                    <span id="marketTrend">Neutro</span>
                </div>
                <div id="graph-container">
                    <canvas id="chart"></canvas>
                </div>
                
                <div class="leverage-selector">
                    <span style="font-size:0.8rem; align-self:center; color:#ccc">Alavancagem:</span>
                    <button class="lev-btn selected" onclick="setLeverage(1)">x1</button>
                    <button class="lev-btn" onclick="setLeverage(5)">x5</button>
                    <button class="lev-btn" onclick="setLeverage(10)">x10</button>
                </div>

                <input type="number" id="tradeAmount" placeholder="Valor para investir" style="width:100%; padding:10px; background:#333; border:none; color:#fff; border-radius:6px; margin-bottom:5px;">
                
                <div id="activeTradeInfo" class="hidden" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; margin-bottom:10px; text-align:center;">
                    Resultado: <strong id="tradePnl">0</strong>
                    <button onclick="closeTrade()" style="background:var(--danger); margin-top:5px;">Fechar Posi√ß√£o</button>
                </div>

                <div class="trade-controls" id="openTradeControls">
                    <button onclick="openTrade('up')" style="background:#00e676; color:#003300;">‚¨Ü COMPRAR (Long)</button>
                    <button onclick="openTrade('down')" style="background:#ff5252; color:#330000;">‚¨á VENDER (Short)</button>
                </div>
            </div>
        </div>

        <!-- Sub: Investments -->
        <div id="sub-market-invest" class="hidden">
            <div class="card" id="investList">
                <!-- Preenchido via JS -->
            </div>
        </div>

        <!-- Sub: Loan -->
        <div id="sub-market-loan" class="hidden">
             <div class="card">
                <h2>Gerente do Banco</h2>
                <div class="stat-box" style="margin-bottom:15px;">
                    <span class="stat-label">D√≠vida Atual</span>
                    <div class="stat-value" id="loanDebt">0</div>
                    <small>Juros: 2% a cada 30s</small>
                </div>
                <input type="number" id="loanInput" placeholder="Valor" style="width:100%; padding:10px; border-radius:6px; border:none;">
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button onclick="takeLoan()" style="flex:1;">Pegar Empr√©stimo</button>
                    <button onclick="payLoan()" class="secondary-btn" style="flex:1;">Pagar D√≠vida</button>
                </div>
             </div>
        </div>
    </div>

    <!-- SECTION: ASSETS (Patrim√¥nio) -->
    <div id="view-assets" class="view-section">
        <div class="sub-tabs">
            <button class="sub-tab-btn active" onclick="switchSubTab('assets', 'houses')">üè† Im√≥veis</button>
            <button class="sub-tab-btn" onclick="switchSubTab('assets', 'vehicles')">üöó Ve√≠culos</button>
            <button class="sub-tab-btn" onclick="switchSubTab('assets', 'gallery')">üñºÔ∏è Galeria</button>
            <button class="sub-tab-btn" onclick="switchSubTab('assets', 'crypto')">üíé Crypto</button>
            <button class="sub-tab-btn" onclick="switchSubTab('assets', 'auction')">üî® Leil√£o</button>
            <button class="sub-tab-btn" onclick="switchSubTab('assets', 'rental')">üîë Aluguel</button>
        </div>
        
        <div id="sub-assets-houses">
            <div id="houseList"></div>
        </div>
        <div id="sub-assets-vehicles" class="hidden">
            <div id="vehicleList"></div>
        </div>
        <div id="sub-assets-gallery" class="hidden">
            <div class="card">
                <p style="color:#ccc; text-align:center;">Seus itens raros e conquistas aparecem aqui.</p>
                <div id="galleryGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(80px, 1fr)); gap:10px; margin-top:10px;"></div>
            </div>
        </div>
        <div id="sub-assets-crypto" class="hidden">
            <div class="card">
                <h2>üíé Carteira de Criptomoedas</h2>
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:10px; margin-bottom:15px;" id="cryptoGrid"></div>
                <div id="cryptoList"></div>
            </div>
        </div>
        <div id="sub-assets-auction" class="hidden">
            <div class="card">
                <h2>üî® Leil√µes de Propriedades</h2>
                <div id="auctionList"></div>
            </div>
        </div>
        <div id="sub-assets-rental" class="hidden">
            <div class="card">
                <h2>üîë Renda de Aluguel</h2>
                <div class="stat-box" style="margin-bottom:15px;">
                    <span class="stat-label">Renda Mensal de Aluguel</span>
                    <div class="stat-value money-highlight" id="rentalTotalDisplay">0</div>
                </div>
                <div id="rentalPropertyList"></div>
            </div>
        </div>
    </div>

    <!-- SECTION: RANKING -->
    <div id="view-ranking" class="view-section">
        <div class="card">
            <h2>üèÜ Leaderboard Global (IA Ativa)</h2>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button onclick="renderRanking('money')" class="secondary-btn">Mais Ricos</button>
                <button onclick="renderRanking('level')" class="secondary-btn">Maior N√≠vel</button>
            </div>
            <div style="background: rgba(0,0,0,0.2); border-radius:8px; padding:10px;">
                <div style="display:flex; justify-content:space-between; padding:5px; color:#777; font-size:0.8rem;">
                    <span># JOGADOR</span>
                    <span>VALOR</span>
                </div>
                <ul id="rankingList" class="ranking-list">
                    <!-- JS -->
                </ul>
            </div>
            <p style="font-size:0.8rem; color:#555; text-align:center; margin-top:10px;">IAs jogam em tempo real. Continue evoluindo!</p>
        </div>

        <div class="card">
            <h2>üí¨ Chat das IAs</h2>
            <div style="background:rgba(0,0,0,0.3); border-radius:8px; padding:10px; height:150px; overflow-y:auto; margin-bottom:10px; font-size:0.85rem;">
                <div id="aiMessageFeed"></div>
            </div>
            <button onclick="clearAiMessages()" class="secondary-btn">Limpar Chat</button>
        </div>
    </div>

    <!-- SECTION: MENU (Settings & Prestige) -->
    <div id="view-menu" class="view-section">
        <div class="card">
            <h2>‚öôÔ∏è Configura√ß√µes</h2>
            <div>Nome: <strong id="playerNameDisplay">-</strong></div>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="text" id="newNameInput" placeholder="Novo nome" style="padding:8px; border-radius:6px; border:none; width:70%;">
                <button class="secondary-btn" style="width:30%; margin-top:0;" onclick="changeName()">Salvar</button>
            </div>

            <div style="margin-top:10px;">
                <span class="stat-label">Divisas</span>
                <div style="display:flex; gap:5px;">
                    <button class="lev-btn currency-btn selected" onclick="setCurrency('BRL')">BRL üáßüá∑</button>
                    <button class="lev-btn currency-btn" onclick="setCurrency('USD')">USD üá∫üá∏</button>
                    <button class="lev-btn currency-btn" onclick="setCurrency('EUR')">EUR üá™üá∫</button>
                </div>
                <small style="color:#999;">C√¢mbio: 1 BRL = <span id="exchangeDisplay">1.00</span></small>
            </div>
            
            <hr style="border-color:rgba(255,255,255,0.1); margin:15px 0;">
            
            <button onclick="restartTutorial()" class="secondary-btn">üéì Rever Tutorial</button>
            <button onclick="forceSave()">üíæ Salvar Manualmente</button>
            <button onclick="exportSave()" class="secondary-btn">Exportar Save</button>
            <button onclick="document.getElementById('importFile').click()" class="secondary-btn">Importar Save</button>
            <input type="file" id="importFile" class="hidden" onchange="importSave(this)">
            <button onclick="resetGame()" class="danger-btn">üóëÔ∏è Resetar Tudo</button>
        </div>

        <div class="card">
            <h2>üéØ Quests Di√°rias</h2>
            <div id="questsList"></div>
            <button onclick="rollNewQuests()" class="secondary-btn" style="margin-top:10px;">üîÑ Trocar Quests (Pr√≥ximas em <span id="questResetTimer">24h</span>)</button>
        </div>

        <div class="card">
            <h2>‚ö° Eventos Ativos</h2>
            <div id="eventsDisplay"></div>
        </div>

        <div class="card">
            <h2>üèÖ Achievements</h2>
            <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:10px;" id="achievementsList"></div>
        </div>

        <div class="card">
            <h2>üèÖ Prest√≠gio</h2>
            <div class="stats-grid">
                <div class="stat-box"><span class="stat-label">Medalhas</span><strong id="prestigeMedals">0</strong></div>
                <div class="stat-box"><span class="stat-label">B√¥nus Global</span><strong id="prestigeBonus">0%</strong></div>
            </div>
            <p style="font-size:0.9rem; color:#ccc; margin-top:10px;">Reseta seu dinheiro e constru√ß√µes, mas mant√©m medalhas e b√¥nus. Requer: 1 Milh√£o.</p>
            <button id="btnPrestige" onclick="doPrestige()" disabled>Prestigiar</button>
        </div>

        <div class="card" id="updatesCard">
            <h2>üìú Atualiza√ß√µes</h2>
            <div id="changelogList" style="max-height:150px; overflow-y:auto; font-size:0.9rem;"></div>
            <button onclick="markUpdatesRead()" class="secondary-btn">Marcar como lidas</button>
        </div>
    </div>

</main>

<!-- BOTTOM NAVIGATION -->
<nav class="bottom-nav">
    <div class="nav-item active" onclick="navTo('home')">
        <span class="nav-icon">üè†</span>In√≠cio
    </div>
    <div class="nav-item" onclick="navTo('market')">
        <span class="nav-icon">üìà</span>Mercado
    </div>
    <div class="nav-item" onclick="navTo('assets')">
        <span class="nav-icon">üè¢</span>Ativos
    </div>
    <div class="nav-item" onclick="navTo('ranking')">
        <span class="nav-icon">üèÜ</span>Ranking
    </div>
    <div class="nav-item" onclick="navTo('menu')">
        <span class="nav-icon">‚ò∞</span>Menu
        <div id="menuNotif" class="notification-dot"></div>
    </div>
</nav>

<!-- Tutorial Overlay -->
<div id="tutorialOverlay" class="overlay hidden">
    <div class="modal">
        <h2 id="tutTitle">Bem-vindo!</h2>
        <p id="tutText">Vamos aprender a ganhar dinheiro?</p>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button class="secondary-btn" onclick="skipTutorial()">Pular</button>
            <button onclick="nextTutorial()">Pr√≥ximo ‚ñ∂</button>
        </div>
    </div>
</div>

<script>
/* =========================================
   CORE VARIABLES & STATE
   ========================================= */
const STATE = {
    money: 0,
    income: 1,
    level: 1,
    passive: 0,
    upgradeCost: 100,
    prestige: 0,
    houses: [],
    vehicles: [],
    gallery: [],
    investments: [], 
    loan: { debt: 0, lastUpdate: Date.now() },
    name: "Player",
    startTime: Date.now(),
    lastSave: Date.now(),
    updatesRead: 0,
    tutorialStep: 0,
    // === NOVOS SISTEMAS ===
    currency: 'BRL', // BRL, USD, EUR
    exchangeRates: { 'BRL': 1, 'USD': 5.2, 'EUR': 5.8 },
    inflation: 1.0, // 1.0 = sem infla√ß√£o, 1.05 = 5% de infla√ß√£o
    cryptoPortfolio: {}, // { 'bitcoin': quantidade, 'ethereum': quantidade, ... }
    auctionedProperties: [], // Propriedades compradas em leil√£o
    rentalIncome: {}, // { propertyId: { monthlyIncome, tenant } }
    achievements: [], // [ 'first_million', 'crypto_trader', etc ]
    dailyQuests: [], // [ { id, target, progress, completed, reward } ]
    lastQuestReset: Date.now(),
    events: [], // [ { type, severity, description, active } ]
    activeEvent: null,
    auctionHistory: [], // Hist√≥rico de leil√µes
    messages: [], // Mensagens das IAs
    totalClicks: 0,
    totalTrades: 0,
    totalSpent: 0
};

const GAME_DATA = {
    investments: [
        { name: "Fundo Conservador", cost: 5000, return: 30, desc: "+30/ciclo" },
        { name: "Start-up Tech", cost: 15000, return: 100, desc: "+100/ciclo" },
        { name: "Minera√ß√£o Bitcoin", cost: 45000, return: 350, desc: "+350/ciclo" },
        { name: "Conglomerado", cost: 150000, return: 1200, desc: "+1200/ciclo" }
    ],
    houses: [
        { name: "Kitnet", cost: 10000, return: 50 },
        { name: "Apartamento", cost: 50000, return: 300 },
        { name: "Mans√£o", cost: 500000, return: 3500 },
        { name: "Ilha Privada", cost: 5000000, return: 40000 }
    ],
    vehicles: [
        { name: "Carro Popular", cost: 20000 },
        { name: "SUV de Luxo", cost: 80000 },
        { name: "Superesportivo", cost: 250000 },
        { name: "Jatinho", cost: 1500000 }
    ],
    updates: [
        "2.1: Tutorial reativ√°vel e inteligente.",
        "2.1: IA de Ranking melhorada e competitiva.",
        "2.1: Not√≠cias em tempo real baseadas na IA.",
        "2.0: Interface totalmente nova!",
    ],
    // === NOVOS DADOS ===
    cryptoAssets: [
        { symbol: 'BTC', name: 'Bitcoin', price: 100000, volatility: 3, icon: '‚Çø' },
        { symbol: 'ETH', name: 'Ethereum', price: 3500, volatility: 4, icon: '‚óÜ' },
        { symbol: 'DOGE', name: 'Dogecoin', price: 0.5, volatility: 5, icon: 'üêï' },
        { symbol: 'XRP', name: 'Ripple', price: 2.5, volatility: 3, icon: '‚ú¶' },
        { symbol: 'ADA', name: 'Cardano', price: 1.2, volatility: 4, icon: '‚ô†' }
    ],
    auctionProperties: [
        { id: 'penthouse_av_paulista', name: 'üè∞ Penthouse Av. Paulista', basePrice: 2000000, rentalYield: 25000, prestige: 'Alta' },
        { id: 'mansao_jardins', name: 'üëë Mans√£o Jardins', basePrice: 1500000, rentalYield: 20000, prestige: 'Alta' },
        { id: 'apto_vila_mariana', name: 'üè¢ Apto Vila Mariana', basePrice: 800000, rentalYield: 12000, prestige: 'M√©dia' },
        { id: 'apto_pinheiros', name: 'üèòÔ∏è Apto Pinheiros', basePrice: 600000, rentalYield: 9000, prestige: 'M√©dia' },
        { id: 'cobertura_itaim', name: '‚≠ê Cobertura Itaim', basePrice: 3000000, rentalYield: 35000, prestige: 'M√°xima' }
    ],
    events: [
        { type: 'crash', severity: 'high', description: 'CRASH NO MERCADO! Todas as a√ß√µes caem 40%', effect: -0.4, duration: 30000 },
        { type: 'opportunity', severity: 'low', description: 'Oportunidade! Pre√ßos em alta. +50% de retorno em investimentos', effect: 0.5, duration: 20000 },
        { type: 'crisis', severity: 'high', description: 'CRISE ECON√îMICA! Infla√ß√£o dispara 15%', effect: 'inflation', duration: 60000 },
        { type: 'boom', severity: 'medium', description: 'BOOM ECON√îMICO! Crypto dispara 80%', effect: 0.8, duration: 25000 },
        { type: 'scandal', severity: 'medium', description: 'Esc√¢ndalo Corporativo. Uma IA perdeu 1 milh√£o!', effect: 'scandal', duration: 10000 }
    ],
    achievements: [
        { id: 'first_million', name: 'üí∞ Primeiro Milh√£o', desc: 'Alcance 1 milh√£o de dinheiro' },
        { id: 'billionaire', name: 'ü§ë Bilion√°rio', desc: 'Alcance 1 bilh√£o' },
        { id: 'level_10', name: 'üìà Escalador', desc: 'Chegue ao n√≠vel 10' },
        { id: 'crypto_trader', name: 'üíé Trader Crypto', desc: 'Compre 5 diferentes criptomoedas' },
        { id: 'property_mogul', name: 'üè∞ Mogul Imobili√°rio', desc: 'Compre 10 propriedades em leil√£o' },
        { id: 'landlord', name: 'üîë Senhor das Propriedades', desc: 'Ganhe 100k com aluguel' },
        { id: 'lucky', name: 'üçÄ Sortudo', desc: 'Sobreviva a um crash de mercado' },
        { id: 'prestige_1', name: 'üèÖ Prest√≠gio I', desc: 'Prestigie uma vez' }
    ],
    dailyQuestTemplates: [
        { type: 'clicks', target: 50, reward: 5000, desc: 'Clique no bot√£o TRABALHAR 50 vezes' },
        { type: 'earn', target: 100000, reward: 10000, desc: 'Ganhe 100k de dinheiro' },
        { type: 'trades', target: 5, reward: 15000, desc: 'Fa√ßa 5 trades' },
        { type: 'invest', target: 500000, reward: 20000, desc: 'Invista 500k' },
        { type: 'level_up', target: 2, reward: 10000, desc: 'Suba 2 n√≠veis' }
    ]
};

// Ranking Simulado & IA
let fakePlayers = [];

// Trade System
let market = { price: 100, history: [], trend: 0, volatility: 0.5 };
let activeTrade = null; 
let leverage = 1;

// Timers
let passiveTimer;
let marketTimer;
let saveTimer;

/* =========================================
   INITIALIZATION
   ========================================= */
window.onload = function() {
    loadGame();
    initUI();
    initRanking();
    startLoops();
    checkTutorial();
    renderAll();
};

function initUI() {
    // Generate Investment Buttons
    const invList = document.getElementById('investList');
    invList.innerHTML = GAME_DATA.investments.map((inv, i) => `
        <button class="buy-btn secondary-btn" onclick="buyInvestment(${i})">
            <div>
                <div style="font-weight:bold; color:var(--primary)">${inv.name}</div>
                <div style="font-size:0.8rem; color:#ccc">${inv.desc}</div>
            </div>
            <div style="text-align:right">
                <div>$${inv.cost.toLocaleString()}</div>
                <small>Comprar</small>
            </div>
        </button>
    `).join('');

    // Generate House List
    const houseList = document.getElementById('houseList');
    houseList.innerHTML = GAME_DATA.houses.map((h, i) => `
        <button class="buy-btn secondary-btn" onclick="buyHouse(${i})">
            <div>üè† ${h.name}</div>
            <div>$${h.cost.toLocaleString()} <br><small>+${h.return}/s</small></div>
        </button>
    `).join('');

    // Generate Vehicle List
    const vehList = document.getElementById('vehicleList');
    vehList.innerHTML = GAME_DATA.vehicles.map((v, i) => `
        <button class="buy-btn secondary-btn" onclick="buyVehicle(${i})">
            <div>üöó ${v.name}</div>
            <div>$${v.cost.toLocaleString()}</div>
        </button>
    `).join('');

    // Initialize Crypto, Auctions, Rental, Quests, Achievements
    renderCrypto();
    renderAuctions();
    renderRental();
    initDailyQuests();
    renderAchievements();
    renderEvents();

    // Changelog
    const logList = document.getElementById('changelogList');
    logList.innerHTML = GAME_DATA.updates.map(u => `<div style="padding:5px; border-bottom:1px solid #333">${u}</div>`).join('');
    
    // Notification
    if(GAME_DATA.updates.length > STATE.updatesRead) {
        document.getElementById('menuNotif').style.display = 'block';
    }
}

/* =========================================
   NAVIGATION SYSTEM
   ========================================= */
function navTo(viewId) {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.getElementById(`view-${viewId}`).classList.add('active');
    
    if(viewId === 'ranking') updateRankingVisuals();
    if(viewId === 'market') resizeChart();
}

function switchSubTab(parent, sub) {
    document.querySelectorAll(`#view-${parent} .sub-tab-btn`).forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    
    const container = document.getElementById(`view-${parent}`);
    container.querySelectorAll('[id^="sub-"]').forEach(d => d.classList.add('hidden'));
    document.getElementById(`sub-${parent}-${sub}`).classList.remove('hidden');
}

/* =========================================
   GAMEPLAY LOGIC
   ========================================= */
function ganharDinheiro() {
    // Valida√ß√£o
    if(STATE.money < 0 || isNaN(STATE.money)) STATE.money = 0;
    
    const prestigeMul = 1 + (STATE.prestige * 0.05); 
    const amount = Math.floor(STATE.income * prestigeMul);
    STATE.money = Math.max(0, STATE.money + amount);
    STATE.totalClicks++;
    
    // Check Quests
    updateQuestProgress('clicks', 1);
    checkAchievement('first_million');
    updateStats();
}

function upgrade() {
    if(STATE.money >= STATE.upgradeCost) {
        STATE.money = Math.max(0, STATE.money - STATE.upgradeCost);
        STATE.income += Math.floor(1 + (STATE.level * 0.5));
        STATE.level++;
        STATE.upgradeCost = Math.floor(STATE.upgradeCost * 1.5);
        
        checkAchievement('level_10');
        updateQuestProgress('level_up', 1);
        renderAll();
    } else {
        alert("‚ùå Dinheiro insuficiente!");
    }
}

function buyInvestment(idx) {
    const item = GAME_DATA.investments[idx];
    const adjustedCost = Math.floor(item.cost * STATE.inflation);
    
    if(STATE.money >= adjustedCost) {
        STATE.money = Math.max(0, STATE.money - adjustedCost);
        STATE.passive += item.return;
        STATE.investments.push(idx);
        STATE.totalSpent += adjustedCost;
        addNews(`‚úÖ Voc√™ comprou: ${item.name}!`);
        updateQuestProgress('invest', adjustedCost);
        checkAchievement('first_million');
        renderAll();
    } else {
        alert(`‚ùå Dinheiro insuficiente! Precisa de ${formatNumber(adjustedCost)}`);
    }
}

function buyHouse(idx) {
    const item = GAME_DATA.houses[idx];
    const adjustedCost = Math.floor(item.cost * STATE.inflation);
    
    if(STATE.money >= adjustedCost) {
        STATE.money = Math.max(0, STATE.money - adjustedCost);
        STATE.passive += item.return;
        STATE.houses.push(idx);
        STATE.totalSpent += adjustedCost;
        addNews(`üè† Im√≥vel adquirido: ${item.name}`);
        renderAll();
    } else {
        alert(`‚ùå Falta verba! Precisa de ${formatNumber(adjustedCost)}`);
    }
}

function buyVehicle(idx) {
    const item = GAME_DATA.vehicles[idx];
    const adjustedCost = Math.floor(item.cost * STATE.inflation);
    
    if(STATE.money >= adjustedCost) {
        STATE.money = Math.max(0, STATE.money - adjustedCost);
        STATE.vehicles.push(idx);
        STATE.totalSpent += adjustedCost;
        addToGallery(`üîë Chave do ${item.name}`);
        addNews(`üöó Ve√≠culo na garagem!`);
        renderAll();
    } else {
        alert(`‚ùå Dinheiro insuficiente! Precisa de ${formatNumber(adjustedCost)}`);
    }
}

function addToGallery(itemName) {
    if(!STATE.gallery.includes(itemName)) {
        STATE.gallery.push(itemName);
        renderGallery();
    }
}

function renderGallery() {
    const grid = document.getElementById('galleryGrid');
    grid.innerHTML = STATE.gallery.map(i => `<div style="background:#333; padding:5px; border-radius:4px; font-size:0.7rem; text-align:center;">${i}</div>`).join('');
}

/* =========================================
   TRADE SYSTEM (MARKET)
   ========================================= */
function initMarket() {
    for(let i=0; i<50; i++) tickMarket(true);
}

function tickMarket(silent = false) {
    if(Math.random() < 0.05) market.trend = (Math.random() - 0.5); 
    
    let change = (Math.random() - 0.5 + market.trend * 0.2) * market.volatility;
    market.price = Math.max(10, market.price + change);
    market.history.push(market.price);
    if(market.history.length > 50) market.history.shift();

    if(!silent) {
        drawChart();
        document.getElementById('marketPrice').innerText = market.price.toFixed(2);
        document.getElementById('marketTrend').innerText = change > 0 ? "Alta ‚ñ≤" : "Baixa ‚ñº";
        document.getElementById('marketTrend').style.color = change > 0 ? varCSS('--success') : varCSS('--danger');
        updateActiveTrade();
    }
}

function drawChart() {
    const ctx = document.getElementById('chart').getContext('2d');
    const container = document.getElementById('graph-container');
    const w = ctx.canvas.width = container.offsetWidth;
    const h = ctx.canvas.height = 220;
    
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);
    
    const min = Math.min(...market.history) * 0.95;
    const max = Math.max(...market.history) * 1.05;
    const range = max - min;
    
    ctx.beginPath();
    ctx.strokeStyle = market.history[market.history.length-1] > market.history[market.history.length-2] ? '#00e676' : '#ff5252';
    ctx.lineWidth = 2;
    
    market.history.forEach((p, i) => {
        const x = (i / (market.history.length-1)) * w;
        const y = h - ((p - min) / range) * h;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

function setLeverage(val) {
    leverage = val;
    document.querySelectorAll('.lev-btn').forEach(b => b.classList.remove('selected'));
    event.target.classList.add('selected');
}

function openTrade(direction) {
    if(activeTrade) return alert("Feche a posi√ß√£o atual antes de abrir outra.");
    
    const val = parseFloat(document.getElementById('tradeAmount').value);
    
    // Valida√ß√£o robusta
    if(!val || isNaN(val) || val <= 0 || !isFinite(val)) {
        return alert("‚ùå Valor inv√°lido!");
    }
    if(val > STATE.money) return alert(`‚ùå Dinheiro insuficiente! Voc√™ tem ${formatNumber(STATE.money)}`);
    
    STATE.money = Math.max(0, STATE.money - val);
    activeTrade = { type: direction, entry: market.price, amount: val, leverage: leverage };
    STATE.totalTrades++;
    
    document.getElementById('activeTradeInfo').classList.remove('hidden');
    document.getElementById('openTradeControls').classList.add('hidden');
    
    updateQuestProgress('trades', 1);
    renderAll();
}

function updateActiveTrade() {
    if(!activeTrade) return;
    const current = market.price;
    const diffPct = (current - activeTrade.entry) / activeTrade.entry;
    const rawPnlPct = activeTrade.type === 'up' ? diffPct : -diffPct;
    const leveragedPnl = rawPnlPct * activeTrade.leverage;
    
    const profit = Math.floor(activeTrade.amount * leveragedPnl);
    const el = document.getElementById('tradePnl');
    el.innerText = (profit > 0 ? "+" : "") + profit;
    el.style.color = profit >= 0 ? varCSS('--success') : varCSS('--danger');
    
    if(leveragedPnl <= -1) {
        closeTrade(true);
    }
}

function closeTrade(forced = false) {
    if(!activeTrade) return;
    const current = market.price;
    const diffPct = (current - activeTrade.entry) / activeTrade.entry;
    const rawPnlPct = activeTrade.type === 'up' ? diffPct : -diffPct;
    const profit = Math.floor(activeTrade.amount * rawPnlPct * activeTrade.leverage);
    
    const totalReturn = Math.max(0, activeTrade.amount + profit);
    STATE.money = Math.max(0, STATE.money + totalReturn);
    
    if(forced) {
        addNews("üî¥ LIQUIDA√á√ÉO! Voc√™ perdeu a posi√ß√£o!");
        checkAchievement('lucky');
    } else {
        addNews(`Trade fechado. Resultado: ${profit > 0 ? '+' : ''}${profit}`);
    }
    
    activeTrade = null;
    document.getElementById('activeTradeInfo').classList.add('hidden');
    document.getElementById('openTradeControls').classList.remove('hidden');
    renderAll();
}

/* =========================================
   LOAN SYSTEM
   ========================================= */
function takeLoan() {
    const val = parseFloat(document.getElementById('loanInput').value);
    
    // Valida√ß√£o
    if(!val || isNaN(val) || val <= 0 || !isFinite(val)) {
        return alert("‚ùå Valor inv√°lido!");
    }
    
    const limit = Math.max(1000, STATE.money * 2); 
    if(STATE.loan.debt + val > limit) {
        return alert(`‚ùå Banco negou. Limite de d√≠vida: ${formatNumber(limit)}`);
    }
    
    STATE.money = Math.max(0, STATE.money + val);
    STATE.loan.debt = Math.max(0, STATE.loan.debt + val);
    addNews(`üí∞ Voc√™ pegou empr√©stimo de ${formatNumber(val)}`);
    renderAll();
}

function payLoan() {
    const val = parseFloat(document.getElementById('loanInput').value);
    
    // Valida√ß√£o
    if(!val || isNaN(val) || val <= 0 || !isFinite(val)) {
        return alert("‚ùå Valor inv√°lido!");
    }
    
    const toPay = Math.min(val, STATE.loan.debt);
    if(STATE.money >= toPay) {
        STATE.money = Math.max(0, STATE.money - toPay);
        STATE.loan.debt = Math.max(0, STATE.loan.debt - toPay);
        addNews(`‚úÖ Voc√™ pagou ${formatNumber(toPay)} da d√≠vida`);
        renderAll();
    } else {
        alert(`‚ùå Dinheiro insuficiente! Voc√™ tem ${formatNumber(STATE.money)}`);
    }
}

/* =========================================
   SMART AI & RANKING (COMPETITIVE)
   ========================================= */
function initRanking() {
    const saved = localStorage.getItem('fakePlayers');
    if(saved) {
        fakePlayers = JSON.parse(saved);
    } else {
        const personas = [
            { name: "Elon M.", strategy: "risk", income: 20 },
            { name: "Jeff B.", strategy: "steady", income: 15 },
            { name: "Warren B.", strategy: "saver", income: 10 },
            { name: "Satoshi N.", strategy: "risk", income: 25 },
            { name: "Mark Z.", strategy: "steady", income: 18 }
        ];
        fakePlayers = personas.map(p => ({
            name: p.name,
            money: Math.floor(Math.random() * 2000),
            level: Math.floor(Math.random() * 5) + 1,
            income: p.income,
            strategy: p.strategy,
            crypto: {},
            auctions: 0
        }));
    }
}

function updateRankingSim() {
    // Calcula velocidade de crescimento do jogador
    const playerVelocity = (STATE.income * 2) + STATE.passive + 10;
    
    fakePlayers.forEach(p => {
        let gain = p.income + (Math.random() * playerVelocity * 0.5);
        const actionRoll = Math.random();
        
        if(p.strategy === "risk" && actionRoll < 0.15) {
            const result = (Math.random() - 0.3);
            gain += gain * result * 5;
            if(result > 0.4) {
                triggerAiNews(p.name, "üí∞ acertou um trade alavancado!");
                aiAddMessage(`${p.name}: Isso √© f√°cil demais! ü§ë`);
            }
        } 
        else if(p.strategy === "steady" && actionRoll < 0.12) {
            p.income += 5;
            gain -= Math.floor(gain * 0.3);
            triggerAiNews(p.name, "üì¶ adquiriu novos im√≥veis.");
            aiAddMessage(`${p.name}: Mais um leil√£o ganho! üè∞`);
        }
        else if(p.strategy === "saver") {
            gain *= 1.08;
            if(actionRoll < 0.05) {
                aiAddMessage(`${p.name}: Paci√™ncia √© ouro... üéØ`);
            }
        }
        
        // Rea√ß√µes a eventos
        if(STATE.activeEvent) {
            const eventEffect = STATE.activeEvent.type === 'crash' ? -0.2 : 0.1;
            gain *= (1 + eventEffect);
        }

        p.money += Math.floor(Math.max(0, gain));
        if(p.money < 0) p.money = 100;

        if(p.money > p.level * 2500 && Math.random() < 0.15) {
            p.level++;
            triggerAiNews(p.name, `‚¨ÜÔ∏è subiu para o N√≠vel ${p.level}!`);
            aiAddMessage(`${p.name}: Subi de n√≠vel! Obrigado mercado! üìà`);
        }
    });
    
    localStorage.setItem('fakePlayers', JSON.stringify(fakePlayers));
    if(document.getElementById('view-ranking').classList.contains('active')) {
        renderRanking('money');
    }
}

function triggerAiNews(name, action) {
    // S√≥ mostra not√≠cia se for sorteado para evitar spam
    if(Math.random() < 0.15) {
        addNews(`${name} ${action}`);
    }
}

function renderRanking(criteria) {
    const list = document.getElementById('rankingList');
    let all = [...fakePlayers, { name: STATE.name + " (Voc√™)", money: STATE.money, level: STATE.level, isPlayer: true }];
    all.sort((a, b) => b[criteria] - a[criteria]);
    
    list.innerHTML = all.map((p, i) => `
        <li class="ranking-item ${p.isPlayer ? 'is-player' : ''}">
            <div style="display:flex; gap:10px; align-items:center;">
                <span class="rank-pos">#${i+1}</span>
                <span>${p.name}</span>
            </div>
            <strong>${criteria === 'money' ? '$' + formatNumber(p.money) : 'Lvl ' + p.level}</strong>
        </li>
    `).join('');
}

function updateRankingVisuals() { renderRanking('money'); }

/* =========================================
   CRYPTO SYSTEM
   ========================================= */
function buyCrypto(symbol) {
    const val = parseFloat(document.getElementById(`cryptoInput_${symbol}`).value);
    const crypto = GAME_DATA.cryptoAssets.find(c => c.symbol === symbol);
    
    if(!val || isNaN(val) || val <= 0 || !isFinite(val)) return alert("‚ùå Valor inv√°lido!");
    
    const cost = val * crypto.price;
    if(STATE.money < cost) return alert(`‚ùå Dinheiro insuficiente!`);
    
    STATE.money = Math.max(0, STATE.money - cost);
    if(!STATE.cryptoPortfolio[symbol]) STATE.cryptoPortfolio[symbol] = 0;
    STATE.cryptoPortfolio[symbol] += val;
    
    addNews(`üíé Voc√™ comprou ${val} ${symbol}!`);
    checkAchievement('crypto_trader');
    renderAll();
}

function sellCrypto(symbol) {
    const val = parseFloat(document.getElementById(`cryptoSellInput_${symbol}`).value);
    const crypto = GAME_DATA.cryptoAssets.find(c => c.symbol === symbol);
    const owned = STATE.cryptoPortfolio[symbol] || 0;
    
    if(!val || isNaN(val) || val <= 0 || !isFinite(val)) return alert("‚ùå Valor inv√°lido!");
    if(val > owned) return alert(`‚ùå Voc√™ s√≥ tem ${owned} ${symbol}`);
    
    const profit = val * crypto.price;
    STATE.money += profit;
    STATE.cryptoPortfolio[symbol] -= val;
    
    addNews(`‚úÖ Voc√™ vendeu ${val} ${symbol} por ${formatNumber(profit)}!`);
    renderAll();
}

function renderCrypto() {
    const grid = document.getElementById('cryptoGrid');
    const list = document.getElementById('cryptoList');
    
    grid.innerHTML = GAME_DATA.cryptoAssets.map(c => {
        const owned = STATE.cryptoPortfolio[c.symbol] || 0;
        const worth = owned * c.price;
        return `
            <div style="background:rgba(0,150,200,0.1); border:1px solid #0099cc; border-radius:8px; padding:10px; text-align:center;">
                <div style="font-size:1.5rem;">${c.icon}</div>
                <div style="font-weight:bold; color:#0ff;">${c.symbol}</div>
                <small style="color:#999;">$${c.price.toFixed(2)}</small>
                <div style="color:#0f0; margin-top:5px; font-size:0.8rem;">Qty: ${owned.toFixed(4)}</div>
                <div style="color:#f90; font-size:0.8rem;">$${formatNumber(worth)}</div>
            </div>
        `;
    }).join('');
    
    list.innerHTML = GAME_DATA.cryptoAssets.map(c => `
        <div style="display:flex; gap:5px; margin-bottom:10px; background:#222; padding:8px; border-radius:6px;">
            <div style="flex:1;">
                <input type="number" id="cryptoInput_${c.symbol}" placeholder="Quantidade" style="width:100%; padding:5px; background:#333; border:none; color:#fff; border-radius:4px; font-size:0.8rem;">
                <button onclick="buyCrypto('${c.symbol}')" style="width:100%; margin-top:3px; padding:5px; background:#0f0; color:#000;">Comprar</button>
            </div>
            <div style="flex:1;">
                <input type="number" id="cryptoSellInput_${c.symbol}" placeholder="Vender" style="width:100%; padding:5px; background:#333; border:none; color:#fff; border-radius:4px; font-size:0.8rem;">
                <button onclick="sellCrypto('${c.symbol}')" style="width:100%; margin-top:3px; padding:5px; background:#f00; color:#fff;">Vender</button>
            </div>
        </div>
    `).join('');
}

function tickCryptoMarket() {
    GAME_DATA.cryptoAssets.forEach(crypto => {
        const change = (Math.random() - 0.5) * crypto.volatility;
        crypto.price = Math.max(0.01, crypto.price * (1 + change / 100));
    });
}

/* =========================================
   AUCTION SYSTEM
   ========================================= */
function renderAuctions() {
    const list = document.getElementById('auctionList');
    list.innerHTML = GAME_DATA.auctionProperties.map((prop, i) => {
        const adjustedPrice = Math.floor(prop.basePrice * STATE.inflation);
        const hasProperty = STATE.auctionedProperties.includes(prop.id);
        
        return `
            <div style="background:#222; padding:10px; border-radius:8px; margin-bottom:8px; border-left:4px solid ${hasProperty ? '#0f0' : '#0ff'};">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold; color:#0ff;">${prop.name}</div>
                        <small style="color:#999;">Renda: ${formatNumber(prop.rentalYield)}/m√™s | Prest√≠gio: ${prop.prestige}</small>
                    </div>
                    <div style="text-align:right;">
                        <div style="color:#0f0; font-weight:bold;">$${formatNumber(adjustedPrice)}</div>
                        <button onclick="buyAuctionProperty('${prop.id}')" style="padding:5px 10px; margin-top:5px; ${hasProperty ? 'opacity:0.5; cursor:not-allowed;' : ''}" ${hasProperty ? 'disabled' : ''}>
                            ${hasProperty ? '‚úÖ Comprado' : 'Licitar'}
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function buyAuctionProperty(propId) {
    const prop = GAME_DATA.auctionProperties.find(p => p.id === propId);
    const adjustedPrice = Math.floor(prop.basePrice * STATE.inflation);
    
    if(STATE.auctionedProperties.includes(propId)) {
        return alert("‚ùå Voc√™ j√° possui esta propriedade!");
    }
    
    if(STATE.money < adjustedPrice) {
        return alert(`‚ùå Dinheiro insuficiente! Precisa de ${formatNumber(adjustedPrice)}`);
    }
    
    STATE.money = Math.max(0, STATE.money - adjustedPrice);
    STATE.auctionedProperties.push(propId);
    STATE.rentalIncome[propId] = { monthlyIncome: prop.rentalYield, tenant: null };
    
    addNews(`üè∞ Voc√™ comprou: ${prop.name}!`);
    checkAchievement('property_mogul');
    renderAll();
}

/* =========================================
   RENTAL SYSTEM
   ========================================= */
function renderRental() {
    const list = document.getElementById('rentalPropertyList');
    let totalRental = 0;
    
    const properties = STATE.auctionedProperties.map(propId => {
        const prop = GAME_DATA.auctionProperties.find(p => p.id === propId);
        const rental = STATE.rentalIncome[propId] || { monthlyIncome: 0 };
        totalRental += rental.monthlyIncome;
        return `
            <div style="background:#1a1a1a; padding:8px; border-radius:6px; margin-bottom:8px; display:flex; justify-content:space-between;">
                <div>
                    <strong style="color:#0ff;">${prop.name}</strong>
                    <br><small style="color:#999;">Renda Mensal: ${formatNumber(rental.monthlyIncome)}</small>
                </div>
                <div style="color:#0f0; font-weight:bold;">+${formatNumber(rental.monthlyIncome)}</div>
            </div>
        `;
    }).join('');
    
    document.getElementById('rentalTotalDisplay').innerText = formatNumber(totalRental);
    list.innerHTML = properties || '<p style="color:#999; text-align:center;">Nenhuma propriedade para alugar ainda.</p>';
}

/* =========================================
   EVENT SYSTEM
   ========================================= */
function triggerRandomEvent() {
    if(STATE.activeEvent) return; // Apenas um evento por vez
    
    const event = GAME_DATA.events[Math.floor(Math.random() * GAME_DATA.events.length)];
    STATE.activeEvent = { ...event, startTime: Date.now() };
    
    addNews(`‚ö†Ô∏è ${event.description}`);
    
    if(event.type === 'inflation') {
        STATE.inflation *= 1.15;
    } else if(event.type === 'crash') {
        fakePlayers.forEach(p => p.money *= 0.6);
    }
    
    setTimeout(() => {
        STATE.activeEvent = null;
        addNews(`‚úÖ Evento terminado.`);
    }, event.duration);
    
    renderAll();
}

function renderEvents() {
    const display = document.getElementById('eventsDisplay');
    if(!STATE.activeEvent) {
        display.innerHTML = '<p style="color:#999; text-align:center;">Nenhum evento ativo no momento.</p>';
        return;
    }
    
    const timeLeft = Math.max(0, STATE.activeEvent.duration - (Date.now() - STATE.activeEvent.startTime));
    display.innerHTML = `
        <div style="background:${STATE.activeEvent.severity === 'high' ? '#ff3333' : '#ff9900'}; padding:10px; border-radius:6px; color:#fff;">
            <strong>${STATE.activeEvent.description}</strong>
            <div style="font-size:0.8rem; margin-top:5px;">Tempo restante: ${Math.ceil(timeLeft / 1000)}s</div>
        </div>
    `;
}

/* =========================================
   ACHIEVEMENT SYSTEM
   ========================================= */
function checkAchievement(id) {
    if(STATE.achievements.includes(id)) return;
    
    let unlock = false;
    
    if(id === 'first_million' && STATE.money >= 1000000) unlock = true;
    if(id === 'billionaire' && STATE.money >= 1000000000) unlock = true;
    if(id === 'level_10' && STATE.level >= 10) unlock = true;
    if(id === 'crypto_trader' && Object.keys(STATE.cryptoPortfolio).length >= 5) unlock = true;
    if(id === 'property_mogul' && STATE.auctionedProperties.length >= 10) unlock = true;
    if(id === 'lucky' && STATE.activeEvent?.type === 'crash') unlock = true;
    if(id === 'prestige_1' && STATE.prestige >= 1) unlock = true;
    
    if(unlock) {
        STATE.achievements.push(id);
        const achv = GAME_DATA.achievements.find(a => a.id === id);
        addNews(`üèÜ ACHIEVEMENT DESBLOQUEADO: ${achv.name}!`);
        aiAddMessage(`${STATE.name}: CONSEGUI! ${achv.name}! üéâ`);
    }
}

function renderAchievements() {
    const list = document.getElementById('achievementsList');
    list.innerHTML = GAME_DATA.achievements.map(achv => {
        const unlocked = STATE.achievements.includes(achv.id);
        return `
            <div style="background:${unlocked ? '#1a3a1a' : '#1a1a1a'}; border:1px solid ${unlocked ? '#0f0' : '#444'}; padding:10px; border-radius:8px; text-align:center; opacity:${unlocked ? '1' : '0.5'};">
                <div style="font-size:1.2rem;">üèÜ</div>
                <strong style="color:${unlocked ? '#0f0' : '#999'};">${achv.name}</strong>
                <small style="display:block; margin-top:3px; color:#ccc;">${achv.desc}</small>
            </div>
        `;
    }).join('');
}

/* =========================================
   DAILY QUEST SYSTEM
   ========================================= */
function initDailyQuests() {
    if(!STATE.dailyQuests.length) {
        generateNewQuests();
    }
    updateQuestTimer();
}

function generateNewQuests() {
    STATE.dailyQuests = [];
    const templates = GAME_DATA.dailyQuestTemplates;
    
    for(let i = 0; i < 3; i++) {
        const template = templates[Math.floor(Math.random() * templates.length)];
        STATE.dailyQuests.push({
            id: i,
            type: template.type,
            target: template.target,
            progress: 0,
            completed: false,
            reward: template.reward,
            desc: template.desc
        });
    }
}

function rollNewQuests() {
    const now = Date.now();
    const hoursSinceReset = (now - STATE.lastQuestReset) / (1000 * 60 * 60);
    
    if(hoursSinceReset < 24) {
        const timeLeft = Math.ceil(24 - hoursSinceReset);
        return alert(`‚ùå Pr√≥ximas quests em ${timeLeft} horas!`);
    }
    
    STATE.lastQuestReset = now;
    generateNewQuests();
    addNews("üéØ Novas quests di√°rias dispon√≠veis!");
    renderAll();
}

function updateQuestProgress(type, amount) {
    STATE.dailyQuests.forEach(q => {
        if(q.type === type && !q.completed) {
            q.progress += amount;
            if(q.progress >= q.target) {
                q.completed = true;
                STATE.money += q.reward;
                addNews(`‚úÖ QUEST CONCLU√çDA! +${formatNumber(q.reward)}`);
                aiAddMessage(`${STATE.name}: Completei mais uma quest! üéØ`);
            }
        }
    });
}

function renderQuests() {
    const list = document.getElementById('questsList');
    list.innerHTML = STATE.dailyQuests.map((q, i) => {
        const progress = Math.min(100, (q.progress / q.target) * 100);
        return `
            <div style="background:#1a1a1a; padding:8px; border-radius:6px; margin-bottom:8px; border-left:3px solid ${q.completed ? '#0f0' : '#0ff'};">
                <div style="display:flex; justify-content:space-between;">
                    <strong style="color:${q.completed ? '#0f0' : '#fff'};">${q.desc}</strong>
                    <span style="color:#0f0;">+${formatNumber(q.reward)}</span>
                </div>
                <div style="background:#333; border-radius:4px; height:6px; margin-top:5px; overflow:hidden;">
                    <div style="background:#0f0; height:100%; width:${progress}%; transition:width 0.3s;"></div>
                </div>
                <small style="color:#999;">${q.progress}/${q.target}</small>
            </div>
        `;
    }).join('');
}

function updateQuestTimer() {
    const now = Date.now();
    const hoursSinceReset = (now - STATE.lastQuestReset) / (1000 * 60 * 60);
    const hoursLeft = Math.ceil(24 - hoursSinceReset);
    document.getElementById('questResetTimer').innerText = `${hoursLeft}h`;
}

/* =========================================
   AI MESSAGE SYSTEM
   ========================================= */
function aiAddMessage(msg) {
    STATE.messages.push({
        text: msg,
        time: new Date().toLocaleTimeString()
    });
    
    if(STATE.messages.length > 20) STATE.messages.shift();
    renderAiMessages();
}

function renderAiMessages() {
    const feed = document.getElementById('aiMessageFeed');
    feed.innerHTML = STATE.messages.map(msg => `
        <div style="padding:5px; border-bottom:1px solid #333; font-size:0.85rem;">
            <span style="color:#0ff;">[${msg.time}]</span> ${msg.text}
        </div>
    `).reverse().join('');
    
    feed.scrollTop = feed.scrollHeight;
}

function clearAiMessages() {
    STATE.messages = [];
    renderAiMessages();
    addNews("Chat limpo.");
}

/* =========================================
   CURRENCY & INFLATION
   ========================================= */
function setCurrency(curr) {
    STATE.currency = curr;
    const rate = STATE.exchangeRates[curr];
    document.getElementById('exchangeDisplay').innerText = `1 BRL = ${rate.toFixed(2)} ${curr}`;
    
    // Trocar bot√µes visuais
    document.querySelectorAll('.currency-btn').forEach(b => b.classList.remove('selected'));
    event.target.classList.add('selected');
    
    addNews(`üí± Moeda alterada para ${curr}`);
}

function updateInflation() {
    // Infla√ß√£o base + eventos
    STATE.inflation *= 1.002; // 0.2% por tick
}

function startLoops() {
    passiveTimer = setInterval(() => {
        if(STATE.passive > 0) {
            const prestigeMul = 1 + (STATE.prestige * 0.05);
            STATE.money = Math.max(0, STATE.money + Math.floor(STATE.passive * prestigeMul));
            updateStats();
        }
        if(STATE.loan.debt > 0) {
            const now = Date.now();
            if(now - STATE.loan.lastUpdate > 30000) {
                STATE.loan.debt = Math.floor(STATE.loan.debt * 1.02);
                STATE.loan.lastUpdate = now;
                addNews("üè¶ Banco cobrou juros!");
            }
        }
    }, 1000);

    initMarket();
    marketTimer = setInterval(() => {
        tickMarket();
        tickCryptoMarket();
        updateInflation();
    }, 500);

    // Save & Ranking & Events (5s)
    saveTimer = setInterval(() => {
        updateRankingSim();
        renderQuests();
        updateQuestTimer();
        if(Math.random() < 0.1) triggerRandomEvent();
        saveGame();
    }, 5000);
}

function updateStats() {
    document.getElementById('moneyDisplay').innerText = formatNumber(STATE.money);
    document.getElementById('incomeDisplay').innerText = formatNumber(STATE.income);
    document.getElementById('passiveDisplay').innerText = formatNumber(STATE.passive);
    document.getElementById('headerLevel').innerText = STATE.level;
    document.getElementById('upgradeCost').innerText = formatNumber(STATE.upgradeCost);
    document.getElementById('loanDebt').innerText = formatNumber(STATE.loan.debt);
    
    const req = 1000000 * (STATE.prestige + 1);
    const btnP = document.getElementById('btnPrestige');
    if(btnP) {
        btnP.innerText = `Prestigiar (Req: ${formatNumber(req)})`;
        btnP.disabled = STATE.money < req;
    }
}

function renderAll() {
    updateStats();
    renderGallery();
    renderCrypto();
    renderAuctions();
    renderRental();
    renderAchievements();
    renderQuests();
    renderEvents();
}

function formatNumber(num) {
    if(num >= 1000000) return (num/1000000).toFixed(2) + 'M';
    if(num >= 1000) return (num/1000).toFixed(1) + 'k';
    return num.toLocaleString();
}

function varCSS(name) {
    return getComputedStyle(document.body).getPropertyValue(name).trim();
}

function addNews(text) {
    const news = document.getElementById('homeNews');
    const ticker = document.getElementById('newsTicker');
    
    // Efeito visual de atualiza√ß√£o
    news.style.backgroundColor = "#2a3b4c";
    ticker.style.opacity = 0;
    
    setTimeout(() => {
        ticker.innerText = text;
        ticker.style.opacity = 1;
        news.style.backgroundColor = ""; 
    }, 300);
}

/* =========================================
   SAVE / LOAD / SETTINGS
   ========================================= */
function saveGame() {
    STATE.lastSave = Date.now();
    localStorage.setItem('bizSimSave_v2', JSON.stringify(STATE));
    document.getElementById('saveStatus').innerText = 'Salvo: ' + new Date().toLocaleTimeString();
}

function loadGame() {
    const data = localStorage.getItem('bizSimSave_v2');
    if(data) {
        const loaded = JSON.parse(data);
        Object.assign(STATE, loaded);
        document.getElementById('playerNameDisplay').innerText = STATE.name;
        document.getElementById('prestigeMedals').innerText = STATE.prestige;
        document.getElementById('prestigeBonus').innerText = (STATE.prestige * 5) + "%";
    }
    
    // Iniciar crypto com pre√ßos aleat√≥rios
    if(Object.keys(STATE.cryptoPortfolio).length === 0) {
        GAME_DATA.cryptoAssets.forEach(c => {
            STATE.cryptoPortfolio[c.symbol] = 0;
        });
    }
}

function forceSave() { saveGame(); alert("Jogo Salvo!"); }

function resetGame() {
    if(confirm("Tem certeza? Isso apaga TUDO.")) {
        localStorage.removeItem('bizSimSave_v2');
        localStorage.removeItem('tutCompleted_v2');
        location.reload();
    }
}

function changeName() {
    const input = document.getElementById('newNameInput');
    const newName = input.value.trim();
    if(newName.length > 0 && newName.length <= 15) {
        STATE.name = newName;
        document.getElementById('playerNameDisplay').innerText = newName;
        saveGame();
        input.value = "";
        alert("Nome alterado com sucesso!");
    } else {
        alert("Nome inv√°lido (use entre 1 e 15 caracteres).");
    }
}

function markUpdatesRead() {
    STATE.updatesRead = GAME_DATA.updates.length;
    document.getElementById('menuNotif').style.display = 'none';
    saveGame();
    alert("Todas lidas!");
}

function doPrestige() {
    const req = 1000000 * (STATE.prestige + 1);
    if(STATE.money < req) return;
    if(!confirm("Ao prestigiar, voc√™ perde dinheiro e ativos, mas ganha medalhas que aumentam seus lucros permanentemente. Continuar?")) return;
    
    STATE.prestige++;
    STATE.money = 0;
    STATE.income = 1;
    STATE.level = 1;
    STATE.passive = 0;
    STATE.upgradeCost = 100;
    STATE.houses = [];
    STATE.vehicles = [];
    STATE.investments = [];
    STATE.loan.debt = 0;
    STATE.auctionedProperties = [];
    STATE.rentalIncome = {};
    STATE.cryptoPortfolio = {};
    STATE.totalClicks = 0;
    STATE.totalTrades = 0;
    STATE.totalSpent = 0;
    
    checkAchievement('prestige_1');
    saveGame();
    location.reload();
}

function exportSave() {
    const data = btoa(JSON.stringify(STATE));
    prompt("Copie este c√≥digo:", data);
}
function importSave(input) {
    const data = prompt("Cole o c√≥digo do save:");
    if(data) {
        try {
            const parsed = JSON.parse(atob(data));
            localStorage.setItem('bizSimSave_v2', JSON.stringify(parsed));
            location.reload();
        } catch(e) { alert("Save inv√°lido"); }
    }
}

/* =========================================
   TUTORIAL
   ========================================= */
const TUTORIAL_STEPS = [
    { target: 'view-home', text: "Bem-vindo! Aqui voc√™ ganha seu dinheiro inicial e melhora suas habilidades." },
    { target: 'view-market', navIdx: 1, text: "No Mercado, voc√™ investe na Bolsa (Trade) e compra Fundos de Investimento." },
    { target: 'view-assets', navIdx: 2, text: "Em Ativos, compre Casas (para renda passiva) e Ve√≠culos (para ostentar na Galeria)." },
    { target: 'view-ranking', navIdx: 3, text: "No Ranking, dispute contra IAs inteligentes para ver quem √© o maior bilion√°rio." }
];

function checkTutorial() {
    if(!localStorage.getItem('tutCompleted_v2')) {
        STATE.tutorialStep = 0;
        showTutorialStep();
    }
}

function restartTutorial() {
    STATE.tutorialStep = 0;
    document.getElementById('tutorialOverlay').classList.remove('hidden');
    navTo('home'); // Volta para o inicio
    showTutorialStep();
}

function showTutorialStep() {
    const step = TUTORIAL_STEPS[STATE.tutorialStep];
    if(!step) {
        document.getElementById('tutorialOverlay').classList.add('hidden');
        localStorage.setItem('tutCompleted_v2', 'true');
        return;
    }
    
    document.getElementById('tutorialOverlay').classList.remove('hidden');
    document.getElementById('tutText').innerText = step.text;
    
    // Highlight Nav Item
    document.querySelectorAll('.nav-item').forEach(el => el.style.color = "");
    if(step.navIdx !== undefined) {
        const navItems = document.querySelectorAll('.nav-item');
        navItems[step.navIdx].style.color = "#00c6ff"; // Highlight
    }
}

function nextTutorial() {
    STATE.tutorialStep++;
    showTutorialStep();
}
function skipTutorial() {
    localStorage.setItem('tutCompleted_v2', 'true');
    document.getElementById('tutorialOverlay').classList.add('hidden');
    document.querySelectorAll('.nav-item').forEach(el => el.style.color = ""); // Reset color
}

function resizeChart() {
    setTimeout(drawChart, 100);
}

</script>
</body>
</html>

